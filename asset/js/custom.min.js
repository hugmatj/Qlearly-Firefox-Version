const WEB_URL = 'https://qlearly.com';

let currentExtUrl = chrome.extension.getURL('/');
var tsBlock = null, entryDetail = null, entryObject = null;
let selectedColumn = null;
let selColumnUsers = [];
let dropdownsetting = null;
var sharableBoard = {},
	currentSession = {};
var gUrl = new URL(window.location.href);
let rightSideBar = '';
var urlTarget = '_self';
var newInvitedUser = [];
if(localStorage.getItem("open_links_in_new_tabs") == 'true') {
	urlTarget = '_blank';
}
var ajaxLastRequest = null;
const serviceController = chrome.extension.getBackgroundPage().getService();
const folder = chrome.extension.getBackgroundPage().getFolder();
const boardController = chrome.extension.getBackgroundPage().getBoard();
const authController = chrome.extension.getBackgroundPage().getAuth();
const EntryCtrl = chrome.extension.getBackgroundPage().getEntry();
var subscriptionInfo = authController.subscription();
const message = $('#message');
const restorableRecord = {};
var userId = null;
const keycodes = {
	'35': 1,
	'40': 2,
	'34': 3,
	'37': 4,
	'12': 5,
	'39': 6,
	'36': 7,
	'38': 8,
	'33': 9,
	'49': 1,
	'50': 2,
	'51': 3,
	'52': 4,
	'53': 5,
	'54': 6,
	'55': 7,
	'56': 8,
	'57': 9
};


if(!authController.isLoggedIn()) {
	var s = document.createElement('script');
	s.src = chrome.extension.getURL('asset/js/auth.js');
	document.body.appendChild(s);
} else {
	userId = authController.user().id;
}

function updateQueryStringParameter(uri, key, value) {
	var re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");
	var separator = uri.indexOf('?') !== -1 ? "&" : "?";
	if (uri.match(re)) {
	  return uri.replace(re, '$1' + key + "=" + value + '$2');
	}
	else {
	  return uri + separator + key + "=" + value;
	}
}

const defaultLinksForColumn = {
	social: [
		{
			title: 'Twitter',
			url: "https://twitter.com/",
			favIconUrl: 'https://www.google.com/s2/favicons?domain=https://twitter.com/'
		},
		{
			title: 'LinkedIn',
			url: "https://www.linkedin.com",
			favIconUrl: 'https://www.google.com/s2/favicons?domain=https://www.linkedin.com'
		},
		{
			title: 'Reddit',
			url: "https://www.reddit.com",
			favIconUrl: 'https://www.google.com/s2/favicons?domain=https://www.reddit.com'
		},
		{
			title: 'Help Center',
			url: "https://help.qlearly.com/v2",
			favIconUrl: 'https://qlearly.com/extension_web/img/Qlearlylogo.png'
		},
		{
			title: 'Getting Started',
			url: "https://help.qlearly.com/v2/getting-started",
			favIconUrl: 'https://qlearly.com/extension_web/img/Qlearlylogo.png'
		},
		{
			title: 'Contact Us',
			url: "https://qlearly.com/contact",
			favIconUrl: 'https://qlearly.com/extension_web/img/Qlearlylogo.png'
		}
	],
	work: [
		{
			title: 'Zapier',
			url: "https://zapier.com",
			favIconUrl: 'https://www.google.com/s2/favicons?domain=https://zapier.com'
		},{
			title: 'Airtable',
			url: "https://airtable.com",
			favIconUrl: 'https://www.google.com/s2/favicons?domain=https://airtable.com'
		},{
			title: 'Slack',
			url: "https://slack.com",
			favIconUrl: 'https://www.google.com/s2/favicons?domain=https://slack.com'
		},{
			title: 'MailChimp',
			url: "https://mailchimp.com",
			favIconUrl: 'https://www.google.com/s2/favicons?domain=https://mailchimp.com'
		}
	],
	checklist: [
		{ title: 'Hi' },
		{ title: 'Welcome' },
		{ title: 'To' },
		{ title: 'Qlearly' },
		{ title: 'Create your own tasks! ðŸ˜Ž' }
	]
};

const openUrl = (evt) => {
	evt.preventDefault();
	if(urlTarget === '_self') {
		chrome.tabs.getCurrent((tab) => {
			chrome.tabs.update(tab.id, { url: evt.currentTarget.getAttribute('href') });
		});
		return;
	}
	chrome.tabs.create({ url: evt.currentTarget.getAttribute('href') });
};

$(document).ready(function () {	

	$(".showSearch").click(function () {
		$(".centermenu").show();
	});
	$(".clearsearch").click(function () {
		$(".centermenu").hide();
	});

	$(document).keydown(function (evt) {

		if (['input', 'textarea'].indexOf(evt.target.tagName.toLowerCase()) > -1) {
			return;
		}

		if ($('.popup-window').length > 0) {
			return;
		}
		

		if (evt.shiftKey) {
			if (keycodes.hasOwnProperty((evt.keyCode).toString())) {
				var clmnObj = $(".column-block:eq(" + (keycodes[evt.keyCode] - 1) + ")");
				if (clmnObj) {
					clmnObj.find('.open-all').trigger('click');
				}
			}
		}
		// Create note
		if (evt.keyCode == 68 && (evt.shiftKey)) {
			evt.preventDefault();
			$('.create-note').first().trigger('click');

		} else if (evt.keyCode == 84 && (evt.shiftKey)) {
			// Create task
			evt.preventDefault();
			$('.create-task').first().trigger('click');

		} else if (evt.keyCode == 65 && (evt.shiftKey)) {
			evt.preventDefault();
			$('#short_cut_modal').modal('show');

		} else if (evt.keyCode == 191 || (evt.keyCode == 191 && (evt.shiftKey))) {

			evt.preventDefault();
			$('#top_search').focus();
		} else if (evt.keyCode == 78 && (evt.shiftKey)) {
			if ($('.makescroll').length < 1) {
				document.location.href = chrome.extension.getURL('board-detail.html');
			} else {
				evt.preventDefault();
				$('.makescroll').animate({
					scrollLeft: $('.makescroll').get(0).scrollWidth
				}, 50, function () {
					$('#create_column_btn').trigger('click');
				});
			}
		} else if (evt.keyCode == 67 && (evt.shiftKey)) {
			evt.preventDefault();
			$('#showCrntSsion').trigger('click');
		} else if (evt.keyCode == 66 && (evt.shiftKey)) {
			evt.preventDefault();
			if ($('#create_board_btn').length < 1) {
				document.location.href = chrome.extension.getURL('index.html');
			}
			$('#create_board_btn').trigger('click');
		} else if (evt.keyCode == 83 && (evt.shiftKey)) {
			evt.preventDefault();
			if ($('.makescroll').length < 1) {
				document.location.href = chrome.extension.getURL('board-detail.html');
			} else {
				$('.makescroll').animate({
					scrollLeft: $('.makescroll').get(0).scrollWidth
				}, 500, function () {
					let obj = currentBoard.createColumn();
					obj.saveSessionBtn.trigger('click');
				});
			}

		}
	});


	$(".showCrntSsion").click(function () {

		if(rightSideBar == $(this).attr('data-type')) {
			$(".sidebarRight").toggleClass('openMenu');
			rightSideBar = $(this).attr('data-type');
			updateCurrentSession();
			make_csc_entry_sortable();
			return;
		}
		rightSideBar = $(this).attr('data-type');
		$(".sidebarRight").addClass('openMenu');
		updateCurrentSession();
		make_csc_entry_sortable()

	});


	var btn = $(".optSettings");
	dropdownsetting = $(".themesettings");

	$(document).on("click", function(event) {
        var $trigger = $(".optSettings");
        if($trigger !== event.target && !$trigger.has(event.target).length){
            $(".themesettings").slideUp();
        }            
    });

	$(".optSettings").click(function (event) {
		event.stopPropagation();
		$(".themesettings").slideToggle();
	});
	

	if ($('#changeTheme').length > 0) {
		if (localStorage.getItem("changeThemeColor") == 'true') {
			if(auth.isLoggedIn()) {
				$('body').addClass('darktheme');
				$('#changeTheme').prop('checked', true);
			}
		} else {
			$('body').removeClass('darktheme');
			$('#changeTheme').prop('checked', false);
		}
	}
	$('body').show();
	$("#changeTheme").change(function () {

		if(!auth.isLoggedIn()){
			$('.open-signup').trigger('click');
			$("#changeTheme").prop('checked', false);
			return false;
		}
		$('body').toggleClass('darktheme');
		if (localStorage.getItem("changeThemeColor") == 'false') {
			localStorage.setItem("changeThemeColor", "true");
			$('#change_theme_txt').html('  Change to light theme');
		} else {
			localStorage.setItem("changeThemeColor", "false");
			$('#change_theme_txt').html('  Change to dark theme');

		}
	});


});



window.addEventListener('error', function(evt) {
	if(evt.target.tagName) {
		if(evt.target.tagName.toLowerCase() == 'img') {
		    if(!evt.target.getAttribute('data-src-error')) {
		      evt.target.setAttribute('data-src-error', 'handle');
		      evt.target.src = evt.target.getAttribute('on-error') || 'asset/image/default_favicon.png';
		    }
		}
	}
}, { capture: true }, true);


function twoDigits(d) {
	if (0 <= d && d < 10) return "0" + d.toString();
	if (-10 < d && d < 0) return "-0" + (-1 * d).toString();
	return d.toString();
}

$.date = function (orginaldate) {
	const monthNames = ["Jan", "Feb", "March", "April", "May", "June", "July", "Aug", "Sep", "Oct", "Nov", "Dec"];
	var date = new Date(orginaldate);
	var day = date.getDate();
	var month = date.getMonth();
	var year = date.getFullYear();
	if (day < 10) {
		day = "0" + day;
	}

	var date = day + " " + monthNames[month] + " " + year;
	return date;
};

Date.prototype.format = function (format) {
	switch (format) {
		case 'mysql':
			return this.getFullYear() + '-' + ("0" + (this.getMonth() + 1)).slice(-2) + '-' + ("0" + this.getDate()).slice(-2) + ' ' + ("0" + this.getHours()).slice(-2) + ':' + ("0" + this.getMinutes()).slice(-2) + ':' + ("0" + this.getSeconds()).slice(-2);
			break;

		default:
			return $.date(this);
			break;
	}

};

Date.prototype.toMysqlFormat = function () {
	return this.getUTCFullYear() + "-" + twoDigits(1 + this.getUTCMonth()) + "-" + twoDigits(this.getUTCDate()) + " " + twoDigits(this.getUTCHours()) + ":" + twoDigits(this.getUTCMinutes()) + ":" + twoDigits(this.getUTCSeconds());
};

String.prototype.ucfirst = function () {
	return this.charAt(0).toUpperCase() + this.slice(1);
};

String.prototype.makeValidUrl = function() {
	if (((this).toLowerCase()).indexOf('http://') === -1 &&
		((this).toLowerCase()).indexOf('https://') === -1 &&
		((this).toLowerCase()).indexOf('file:///') === -1 &&
		((this).toLowerCase()).indexOf('chrome-extension://') === -1
	) {
		return 'http://' + this.charAt(0) + this.slice(1);
	}
	return this.charAt(0) + this.slice(1);
};


String.prototype.toDate = function (format) {
	return (new Date(this)).format(format);
};

Array.prototype.insert = function (index, item) {
	this.splice(index, 0, item);
};

Array.prototype.getIndex = function (by, value) {
	return this.map(function (item) {
		return String(item[by]);
	}).indexOf(String(value));
};

function getIndexById(array_value, id) {
	return array_value.map(function (img) {
		return String(img.id);
	}).indexOf(String(id));
}

function isValidUsername(str) {
	var pattern = /^[A-Za-z][A-Za-z0-9]*(?:_+[A-Za-z0-9]+)*$/;
	return pattern.test(str);
}

function isValidShotCode(str) {
	var pattern = /^[a-z0-9_-]+$/i;
	return pattern.test(str);
}

function changeSharableLink(sharable_code, shareFor) {

	shareFor = shareFor || 'c';
	var container = $('#share_column');
	if (shareFor == 'c') {
		container = $('#share_column_2');
	}
	container.find('.column_sharable_url').html(
		`<a href="${WEB_URL}/x/${shareFor}/${sharable_code}" target="_blank">
			${WEB_URL}/x/${shareFor}/${sharable_code}
		</a>`);
	container.find('.remove-sharable-link').show();
	container.find('.create-sharable-link').hide();
	container.find('.edit-sharable-link').show();
}

function defualtSharableLink() {
	var container = $('#share_column');
	container.find('.column_sharable_url').html('Share this board via link');
	container.find('.remove-sharable-link').hide();
	container.find('.create-sharable-link').show();
	container.find('.edit-sharable-link').hide();

	var container = $('#share_column_2');
	container.find('.column_sharable_url').html('Share this column via link');
	container.find('.remove-sharable-link').hide();
	container.find('.create-sharable-link').show();
	container.find('.edit-sharable-link').hide();
}

function isUrlValid(userInput) {
	let regexp = /(http(s)?:\/\/.)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/g;

	if (!userInput.match(regexp)) {
		return false;
	}
	return true;
}

function isEmailValid(email) {
	var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
	return re.test(String(email).toLowerCase());
}

function guid() {
	function s4() {
		return Math.floor((1 + Math.random()) * 0x10000)
			.toString(16)
			.substring(1);
	}

	return s4() + s4() + '-' + s4() + '-' + s4();
}





const controller = {
	getAllBookmarks: function(callback) {
		var allBookmarks = [], uncategories = [];
		chrome.bookmarks.getTree(function ( data ) {
			if(data.length > 0) {
				data[0].children.forEach(item => {
					item.children.forEach(folder => {
						if(folder.hasOwnProperty('children')){
							allBookmarks =  allBookmarks.concat(folder.children);
						} else {
							allBookmarks.push(folder);
							uncategories.push(folder);
						}
					});
				});

				callback({
					allBookmarks: allBookmarks.sort(function (a, b) {
						return b.dateAdded - a.dateAdded;
					}),
					uncategories: uncategories
				});
			}
		});
	},
	getBookmarkFolder: function(callback) {
		var allBookmarks = [];
		chrome.bookmarks.getTree(function ( data ) {
			if(data.length > 0) {
				// get the id of uncategories bookmark
				// if(data[0].children) {
				// 	if(data[0].children[1]) {
				// 		uncategoriesBookmarkId = data[0].children[1].id;
				// 	}
				// }
				data[0].children.forEach(item => {
					
					allBookmarks.push({
						dateAdded: item.dateAdded,
						dateGroupModified:item.dateGroupModified,
						id: item.id,
						index: item.index,
						parentId: item.parentId,
						title: item.title,
					});

					item.children.forEach(folder => {

						if(folder.hasOwnProperty('children')){
							allBookmarks.push(folder);
							if(folder.hasOwnProperty('children')){
								folder.children.forEach(folder2 => {
									if(folder2.hasOwnProperty('children')){
										allBookmarks.push(folder2);
										
										if(folder2.hasOwnProperty('children')){
											folder2.children.forEach(folder3 => {
												if(folder3.hasOwnProperty('children')){
													allBookmarks.push(folder3);

													if(folder3.hasOwnProperty('children')){
														folder3.children.forEach(folder4 => {
															if(folder4.hasOwnProperty('children')){
																allBookmarks.push(folder4);

																if(folder4.hasOwnProperty('children')){
																	folder4.children.forEach(folder5 => {
																		if(folder5.hasOwnProperty('children')){
																			allBookmarks.push(folder5);
																			
																			if(folder5.hasOwnProperty('children')){
																				folder5.children.forEach(folder6 => {
																					if(folder6.hasOwnProperty('children')){
																						allBookmarks.push(folder6);
																					}
																				});
																			}

																		}
																	});
																}

															}
														});
													}

												}
											});
										}

									}
								});
							}
						}
					});
				});

				callback(allBookmarks);
			}
		});

	}
};

const auth = {
	user: function () {
		return RSStorage.getUser();
	},
	isLoggedIn: function () {
		if (RSStorage.getUser()) {
			return true;
		}
		return false;
	},
	getToken: function () {
		return RSStorage.getUser().token;
	},
	login: function (param) {

		param.login = param.email;
		param.request_via = 'ext';

		let oldValue = $('#login_btn').html();
		$('#login_btn').html('<div class="small-loader"></div>');

		service.post2("admin/post-login", param, function (response) {

			if (response.success === false) {
				$('#login_btn').html(oldValue);
				alert(response.message);
				return;
			}

			if(!response.result) {
				$('#login_btn').html(oldValue);
				alert('Oops! Something went wrong');
				return;
			}


			RSStorage.setUser(response.result);

			sync2(function(){
				document.location.reload();
			}, true);

		});
	},
	register: function (param) {

		return new Promise(function (resolve, reject) {

			param.request_via = 'ext';
			service.post("admin/register", param).then(function (response) {

				if (!response.hasOwnProperty('id')) {
					reject(response);
					return;
				}

				RSStorage.setUser(response);

				sync2(function(){

					document.location.reload();

				}, true);

			})
			.catch(function (response) {
				reject(response);
			});
		});
	},
	forgot: function (param) {

		return new Promise(function (resolve, reject) {

			service.get("admin/forgot-password?email=" + param.email).then(function (response) {
				alert(response.message);
				if (response.success == true) {
					resolve(response);
					return;
				}
				reject(response);
			});
		});


	},
	canAccessNonLoggedIn: function () {
		if (auth.isLoggedIn()) {
			document.location.href = chrome.extension.getURL('index.html');
		}
	},
	logout: function () {
		RSStorage.logoutUser();
		board.save2([]);
		entry.save2([]);
		folder.save([]);
		localStorage.setItem("changeThemeColor", "true");
	}
};

const service = {
	endpoint: serviceController.endpoint,
	version: serviceController.version,
	get: function (url) {

		return new Promise(function (resolve, reject) {

			var headers = {
				"accept": "application/json"
			};

			if (auth.isLoggedIn()) {
				headers['authorization'] = "Bearer " + auth.getToken();
			}

			ajaxLastRequest = $.ajax({
				url: service.endpoint + url,
				headers: headers,
				success: function (result) {
					resolve(result);
				},
				error: function (response) {
					reject(response);
				}
			});
		});
	},
	post: function (url, data) {

		return new Promise(function (resolve, reject) {
			let header = {
				"accept": "application/json"
			};
			if (auth.isLoggedIn()) {
				header['authorization'] = "Bearer " + auth.getToken();
			}

			data.via = 'extension';

			ajaxLastRequest = $.ajax({
				url: service.endpoint + url,
				method: 'POST',
				data: data,
				headers: header,
				success: function (result) {
					resolve(result);
				},
				error: function (response) {
					reject(response.responseText);
				}
			});
		});
	},
	post2: function (url, data, callback) {

		let header = {
			"accept": "application/json"
		};
		if (auth.isLoggedIn()) {
			header = {
				"Content-Type": "application/x-www-form-urlencoded;charset=utf-8",
				"Authorization": "Bearer " + auth.getToken()
			};
		}

		ajaxLastRequest = $.ajax({
			url: this.endpoint + url,
			method: 'POST',
			data: data,
			headers: header,
			success: function (result) {
				callback(result);
			},
			error: function (response) {
				callback(response);
			}
		});
	},
	delete: function (url, data, callback) {
		let header = {};
		if (auth.isLoggedIn()) {
			header = {
				"Content-Type": "application/x-www-form-urlencoded;charset=utf-8",
				"Authorization": "Bearer " + auth.getToken()
			};
		}
		ajaxLastRequest = $.ajax({
			url: this.endpoint + url,
			method: 'DELETE',
			data: data,
			headers: header,
			success: function (result) {
				callback(result);
			}
		});
	},
	createOrUpdateBoard: function(id, callback) {

		if (auth.isLoggedIn()) {
			service.post(service.version + "board", board.first(id)).then(function (response) {
				callback(response);
			});
		}
	},
	createOrUpdateEntry: function(id) {
		if (auth.isLoggedIn()) {
			service.post(service.version + "entry", entry.first(id)).then(function (response) {
				if(response.success) {
					entry.synced([id]);
				}
			});
		}
	},
	createOrUpdateMultipleEntry: function(data) {
		if (auth.isLoggedIn()) {
			service.post(service.version + "entry/multi", { entries: data }).then(function (response) {
				
			});
		}
	},
	removeEntry: function() {
		if (auth.isLoggedIn()) {
			service.delete(service.version + "entry", {
					remove_entries: JSON.stringify(entry.getRemovedItem().map(a => a.id))
				},
				function (response) {
					if(response.success) {
						entry.saveRemoved([]);
					}
			});
		}
	},
	restoreEntry: function() {
		if (auth.isLoggedIn()) {
			service.post(service.version + "entry", {
					entries: JSON.stringify(entry.getSyncable().map(a => a.id))
				},
				function (response) {
					// if(response.success) {
					// 	entry.saveRemoved([]);
					// }
			});
		}
	},
	saveEntryOrder: function(ids) {
		if (auth.isLoggedIn()) {
			service.post(service.version + "entry/change-order", { entries: JSON.stringify(ids) })
			.then( function (response) {
						
			});
		}
	},
	getServerData: function(callback) {
		if (auth.isLoggedIn()) {
			service.get(service.version + "get").then( function (response) {
				
				if (response.success == true) {
					board.save2(response.data);
					entry.save2(response.entry);
				}
				callback(response);

			});
		}
	},
	moveColumn: function(boardId, columnId) {
		if (!auth.isLoggedIn()) { return; }

		service.post(service.version + "move-column", { boardId: boardId, columnId: columnId })
		.then( function (response) {
					
		});

	}
};

const users = {
	data: [],
	storagename: 'qleary_users',
	get: function () {
		if (!localStorage.getItem("qleary_users")) {
			return this.data = [];
		}
		return this.data = JSON.parse(localStorage.getItem("qleary_users"));
	},
	save: function (value) {
		localStorage.setItem("qleary_users", JSON.stringify(value));
	},
	first: function(id) {
		this.get();

		var result = this.data.filter(obj => {
			return obj.id == id;
		});
		if (result[0]) {
			return result[0];
		}
		return {};
	},
	updateBatch: function (users) {
		let _ = this,
		index = -1;

		this.get();
		users.forEach(function (item) {
			index = _.data.getIndex('email', item.email);
			if (index > -1) {
				if (item.hasOwnProperty('board_id')) {
					if (typeof item.board_id == 'object') {
						_.data[index]['board_ids'] = _.data[index]['board_ids'].concat(item.sharable_id);
					} else {
						_.data[index]['board_ids'] = item.board_id;
					}
				}
			} else {
				_.data.push(_.verifyObject(item));
			}
		});

		this.save(this.data);
	},
	verifyObject: function (item) {

		item.board_ids = item.board_ids || [];
		item.board_id = item.board_id || [];

		if (typeof item.board_id == 'object') {

			item.board_ids = item.board_ids.concat(item.board_id);
		}

		return {
			id: item.id || guid(),
			name: item.name || item.email || '',
			email: item.email || '',
			board_ids: item.board_ids || [],
			status: 'invitation_sent'
		};
	},
	update: function (para) {

		let index = this.data.getIndex('email', para.email);
		if(index > -1) {
			this.data[index] = para;
		}
		this.save(this.data);
	},
	removeProject: function (id, boardId) { }

};


$('#import_bookmark_btn').click(function() {
	if($("input[name='bookmarkfolders']:checked").length < 1) {
		$('#flash-data').html(`
			<div class="alert alert-danger">
			<strong>Fail!</strong> Please select at least one folder to import.
			</div>
		`);
		return;
	}

	if($("input[name='addbookmark']:checked").val() == 'selected_bm') {


		var folderDetail = folder.create({ title: ''});
		var obj = boardController.create({
			folder_id: folderDetail.id,
			name: "Primary Board",
			is_favorite: 1,
			column: []
		});

		currentBoard.id = obj.id;
	}

	$.each($("input[name='bookmarkfolders']:checked"), function() {
		
		 chrome.bookmarks.get(this.value, function(bFolder) {
			
			bFolder = bFolder[0];
			if(bFolder) {
				var obj = boardController.createNewColumn(currentBoard.id, {
					type: "link", 
					name: bFolder.title.ucfirst()
				});


				chrome.bookmarks.getChildren(bFolder.id, function(bookmarks) {

					bookmarks.map((item, index) => {
						if(item.hasOwnProperty('url')) {
							entry.create({
								board_id: currentBoard.id,
								column_id: obj.obj.id,
								title: item.title,
								url: item.url,
								sortable: index + 1,
								favIconUrl: 'https://www.google.com/s2/favicons?domain=' + item.url
							});
						}
					})

				});
			}
		 });
	});
	$('#flash-data').html(`
		<div class="alert alert-success">
		<strong>Success!</strong> Folder has been imported!
		</div>
	`);
	setTimeout(function() {
		$('#select_folder').modal('hide');
		if($("input[name='addbookmark']:checked").val() == 'selected_bm') {
			localStorage.setItem("qleary_is_default_created", "true");
			document.location.reload();
		}

		if ($('.board-detail-page').length > 0) {
			currentBoard.init();
		}
	}, 2000);
	
});

$('#select_folder').on('hidden.bs.modal', function() {
	$('#flash-data').html('');
});
$('#select_folder').on('shown.bs.modal', function() {
	controller.getBookmarkFolder(function(bookmarks) {
		$('#bookmark_modal').html('');
		bookmarks.forEach((bookmark, index) => {
			$('#bookmark_modal').append(`
				<span class="mr-2 pointer">
	                <input type="checkbox" name="bookmarkfolders" value="${bookmark.id}" ${(index==0)? 'checked="checked"': ''} autocomplete="bookmarkfolders" >
	                <label class="color3">${bookmark.title.ucfirst()}</label>
              	</span>`
            );
		});
	});

});



$('#choose_bn_skip').click( function() {
	addBookmarkManually();
});

function addBookmarkManually() {
	boardController.createDetault(function(response){
		saveBookMarks(response.bookmark.id, response.board.id);
		defaultSocialColumn(response.socialColumn.id, response.board.id);
		defaultWorkColumn(response.workColumn.id, response.board.id);
		defaultChecklistColumn(response.checklistColumn.id, response.board.id);
	});
	
	localStorage.setItem("qleary_is_default_created", "true");
	document.location.reload();
}

$('#choose_bn_next').click( function() {
	
	if(!$("input[name='addbookmark']:checked").val()) {
		alert('Please choose a option from above two option');
		return;
	}

	$('#add_bookmark').modal('hide');

	if($("input[name='addbookmark']:checked").val() == 'manually') {
		addBookmarkManually();
	} else {
		$('#select_folder').modal({backdrop: 'static', keyboard: false});
	}

});

$('#choose_bn_back').click( function() {
	$('#select_folder').modal('hide');
	$('#add_bookmark').modal({backdrop: 'static', keyboard: false});
});

var board = {
	boards: [],
	getAll: function () {

		this.boards = boardController.getAll();
		if (this.boards.length <= 0) {
			if (!localStorage.getItem("qleary_is_default_created")) {
				$('#choose_back_btn2').addClass('d-none');
				$('#choose_bn_back').removeClass('d-none');
				$('#add_bookmark').modal({backdrop: 'static', keyboard: false});
				return [];
			}
		}
		return this.boards;
	},
	get: function () {
		return boardController.get();
	},
	default: function () {
		return this.getAll()[0];
	},
	favorite: function () {
		return boardController.favorite();
	},
	first: function (id) {
		return boardController.first(id);
	},
	columns: function () {
		this.getAll();

		var result = [];
		this.boards.forEach(obj => {
			result = result.concat(obj.column.map( item => { 
				item.board_id = obj.id; 
				return item; 
			}));
		});
		
		return result;
	},
	column: function (id) {
		this.getAll();

		var result = this.boards.filter(obj => {
			return obj.id == id;
		});
		if (result[0]) {
			return result[0].column;
		}
		return [];
	},
	getCoumn: function (id) {
		return boardController.getCoumn(id);
	},
	create: function (data) {

		this.get();
		if (!data.hasOwnProperty('is_favorite')) {
			data.is_favorite = 0;
		}
		let currentIndex = this.boards.length;

		if(!data.hasOwnProperty('id')) {
			data.id = guid();
		}
		if(!data.hasOwnProperty('column')) {
			data.column = [];
		}
		if(!(data.column instanceof Array)) {
			data.column = [];
		}

		if(data.column.length < 1) {
			data.column = [
				board.columnObject('Rename me')
			];
		}

		let bObj = {
			id: data.id,
			name: data.name || 'Unnamed board',
			folder_id: data.folder_id || '',
			is_favorite: data.is_favorite,
			sharable_code: '',
			sortable: data.sortable || currentIndex, 
			column: data.column,	
			sync: "true",			
			created_at: data.created_at || (new Date()).toMysqlFormat()
		};
		if(data.hasOwnProperty("restore")) {
			bObj.restore = data.restore
		}
		this.boards.push(bObj);

		this.save(this.boards);
		return bObj;
	},
	udpate: function (index, data, when) {		

		when = when || 'sync';
		if (data.hasOwnProperty('name')) {
			this.boards[index].name = data.name || 'Unnamed board';
		}

		if (data.hasOwnProperty('meta_title')) {
			this.boards[index].meta_title = data.meta_title;
		}

		if (data.hasOwnProperty('author_url')) {
			this.boards[index].author_url = data.author_url;
		}

		if (data.hasOwnProperty('meta_title')) {
			this.boards[index].seo_author = data.seo_author;
		}
 
		if (data.hasOwnProperty('meta_description')) {
			this.boards[index].meta_description = data.meta_description;
		}

		if (data.hasOwnProperty('image')) {
			this.boards[index].image = data.image;
		}

		if (data.hasOwnProperty('is_favorite')) {
			this.boards[index].is_favorite = data.is_favorite;
		}

		if (data.hasOwnProperty('sharable_code')) {
			this.boards[index].sharable_code = data.sharable_code;
		}

		if (data.hasOwnProperty('sortable')) {
			this.boards[index].sortable = data.sortable;
		}
		
		this.boards[index].sync = "true";
		
		if (when == 'sync') {
			this.save(this.boards);
		} else if (when == 'not_sync') {
			this.save2(this.boards);
		}
		return true;
	},
	updateById: function (id, data, when) {
		return this.udpate(getIndexById(this.boards, id), data, when);
	},
	removeFavorite: function () {
		for (var i in this.boards) {
			this.boards[i].is_favorite = 0;
		}

		this.save2(this.boards);
	},
	remove: function ($key) {
		this.createRemoved(this.boards[$key]);
		entry.deleteByBoard(this.boards[$key]);
		this.boards.splice($key, 1);
		this.save(this.boards);
	},
	save: function (value) {
		localStorage.setItem("qleary_board", JSON.stringify(value));
		sync2('', false);
		createContextMenu();
	},
	save2: function (value) {
		localStorage.setItem("qleary_board", JSON.stringify(value));
		createContextMenu();
	},
	restore: function (id) {

		if(restorableRecord['board_' + id]) {
			restorableRecord['board_' + id].restore = true;
			restorableRecord['board_' + id].column.map(function(item){
				item.restore = true;
				return item;
			});
			board.create(restorableRecord['board_' + id]);
			board.render();
			entry.restore(id);
			// currentBoard.columns.instance[]
		}
	},
	restoreColumn: function (id, boardId) {

		if(restorableRecord['column_' + id]) {
			
			board.deleteRemovedColumn(id);
			let newColumn = board.createNewColumn(boardId, restorableRecord['column_' + id]);
			if(restorableRecord['columns_entry_' + id]) {
				entry.restoreByColumn(id);
			}
			if(currentBoard.id == boardId) {
				currentBoard.columns.createNewElement(newColumn.obj, newColumn.index);
			}
		}
	},

	getRemovedItem: function () {
		if (!localStorage.getItem("qleary_board_removed")) {
			return [];
		}
		return JSON.parse(localStorage.getItem("qleary_board_removed"));
	},
	deleteRemovedColumn: function(id) {
		let data = this.getRemovedColumn();
		let index = data.map(function (item) {
			return String(item.id);
		}).indexOf(String(id));
		if (index > -1) {
			data.splice(index, 1);
			this.saveRemovedColumn(data);
		}
	},
	saveRemoved: function (value) {
		localStorage.setItem("qleary_board_removed", JSON.stringify(value));
	},
	createRemoved: function (value) {
		let items = this.getRemovedItem();
		if(items) {
			items.push(value);
			this.saveRemoved(items);
		}
	},

	getRemovedColumn: function () {
		if (!localStorage.getItem("qleary_column_removed")) {
			return [];
		}
		return JSON.parse(localStorage.getItem("qleary_column_removed"));
	},
	saveRemovedColumn: function (value) {
		localStorage.setItem("qleary_column_removed", JSON.stringify(value));
	},
	createRemovedColumn: function (value) {
		let items = this.getRemovedColumn();
		if(value) {
			items.push(value);
			this.saveRemovedColumn(items);
		}
	},
	createNewColumn: function (boardid, param) {

		let bid = this.getIndexById(this.boards, boardid);
		param.restore = true;
		
		let obj = this.columnObject('Column Name', param);
		this.boards[bid].column.push(obj);
		this.save(this.boards);
		return {
			index: (this.boards[bid].column).length,
			obj: obj
		};
	},
	copyColumn: function (boardid, columnid, callback) {

		let obj = board.getCoumn(columnid);
		
		let index = this.boards.getIndex('id', boardid);
				
		if(index !== -1) {
			var entries = entry.getByColumn(obj.id);
			 
			obj = board.createNewColumn(boardid, {
				name: obj.name
			});

			entries.map(item => {
				item.id = guid();
				item.board_id = boardid;
				item.column_id = obj.obj.id;

				entry.create(item);
				return item;
			});
			
			callback({
				index: (this.boards[index].column).length,
				obj: obj.obj,
				entries: entries
			});
		}
	},
	moveColumn: function (boardid, columnid) {

		let obj = board.getCoumn(columnid);
		let index = this.boards.getIndex('id', boardid);
				
		if(index !== -1) {
			let index2 = this.boards.getIndex('id', obj.board_id);
			obj.board_id = boardid;
			this.boards[index].column.push(obj);

			let columnIndex = this.getIndexById(this.boards[index2].column, columnid);
			
			this.boards[index2].column.splice(columnIndex, 1);
			this.save2(this.boards);		

			return {
				index: (this.boards[index].column).length,
				obj: obj
			};
		}
	},
	columnObject: function ( name, param ) {

		return boardController.columnObject( name, param );
		// param = param || {};
		
		// let cObj = {
		// 	id: param.id || guid(),
		// 	name: param.name || name,
		// 	type: param.type || 'link',
		// 	sync: "true",
		// 	created_at: param.created_at || (new Date()).toMysqlFormat()
		// };

		// if(param.hasOwnProperty("restore")) {
		// 	cObj.restore = param.restore;
		// }
		// cObj.sync = "true";
		// return cObj;
	},
	getIndexById: function (array_value, id) {
		return array_value.map(function (img) {
			return String(img.id);
		}).indexOf(String(id));
	},
	updateAllColumn: function (boardId, data) {
		let index = this.getIndexById(this.getAll(), boardId);

		this.boards[index].column = data;

		this.save(this.boards);
		return true;

	},
	updateColumn: function (id, data, when) {

		when = when || 'sync';
		let index = this.getIndexById(this.boards, currentBoard.id);

		let index2 = this.getIndexById(this.boards[index].column, id);

		if (data.hasOwnProperty('name')) {
			this.boards[index].column[index2].name = data.name
		}
		if (data.hasOwnProperty('author')) {
			this.boards[index].column[index2].author = data.author
		}

		if (data.hasOwnProperty('author_url')) {
			this.boards[index].column[index2].author_url = data.author_url
		}

		if (data.hasOwnProperty('meta_title')) {
			this.boards[index].column[index2].meta_title = data.meta_title
		}

		if (data.hasOwnProperty('meta_description')) {
			this.boards[index].column[index2].meta_description = data.meta_description
		}
		if (data.hasOwnProperty('sharable_code')) {
			this.boards[index].column[index2].sharable_code = data.sharable_code
		}
		this.boards[index].column[index2].sync = "true";
		if (when == 'sync') {
			this.save(this.boards);
		} else if (when == 'not_sync') {
			this.save2(this.boards);
		}
		return true;
	},
	deleteColumn: function (columnId, boardId) {
		board.getAll();
		let index = this.getIndexById(this.boards, boardId);
		if (index !== -1) {
			let index2 = this.getIndexById(this.boards[index].column, columnId);
			this.createRemovedColumn(this.boards[index].column[index2]);
			this.boards[index].column.splice(index2, 1);
			entry.removeByColumn(columnId);
			this.save(this.boards);

			return true;
		}

		return false;

	},
	render: function () {
		try {
			$('.rendered-board-block').remove();

			if ($('#create_board_form').length > 0) {
				$('#create_board_form').before(
					board.getAll().map(function (item, $index) {
						return boardTemplate.render(item, $index);
					}).join('\n')
				);

				boardTemplate.registerEvent();
				boardTemplate.makeSortable();
			}

		} catch (e) {
			alert(e);
		}
	},
	renderMenu: function () {
		$('#board_menu').html('');

		var allLinks = EntryCtrl.get();
		folder.get().forEach((item) => {

			$('#board_menu').append('<div class="dropdownHead">' + String(item.title || 'Unnamed Folder').ucfirst() + '</div>');

			boardController.getByFolder(item.id).forEach(function (item, $index) {
				if (!item.name) {
					item.name = 'Unnamed board';
				}
				let totalLinks = allLinks.filter(link => {
					return (link.board_id === item.id);
				}).length;
				let btn = $('<a class="dropdown-item text-truncate d-flex justify-content-between" href="#"><span>' + item.name.ucfirst() + '</span><span class="counter">'+ totalLinks + '</span></a>');
	
				btn.click(function () {
					RSStorage.setCurrentBoardId(item.id);
					currentBoard.id = item.id;
					//sync2();
					currentBoard.init();
					
					$('#selected_board_name').val(item.name.ucfirst());
	
					$('#make_favorite').removeAttr('checked');
					if(item.is_favorite === 1) {
						$('#make_favorite').attr('checked', 'false')
					}
				});
	
				$('#board_menu').append(btn);
			});

		});

		// board.getAll().map(function (item, $index) {
		// 	if (!item.name) {
		// 		item.name = 'Unnamed board';
		// 	}
		// 	let btn = $('<a class="dropdown-item text-truncate" href="#">' + item.name.ucfirst() + '</a>');

		// 	btn.click(function () {
		// 		RSStorage.setCurrentBoardId(item.id);
		// 		currentBoard.id = item.id;
		// 		currentBoard.init();
		// 		$('#selected_board_name').val(item.name.ucfirst());

		// 		$('#make_favorite').removeAttr('checked');
		// 		if(item.is_favorite === 1) {
		// 			$('#make_favorite').attr('checked', 'false')
		// 		}
		// 	});

		// 	$('#board_menu').append(btn);
		// });
	},
	renderOuterMenu: function () {
		$('#pop_choose_board').html('');

		if (!board.getAll().length > 0) {
			$('#pop_choose_board').append('<option value="no_board"> Create New Board</option>');
			return;
		}

		board.getAll().map(function (item, $index) {
			$('#pop_choose_board').append('<option value="' + item.id + '">' + item.name + '</option>');
			$('#pop_choose_board').val(currentBoard.id);
		});

		$('#pop_choose_board').append('<option value="new_board"> + Create Board </option>');
	},
};

const loaderComponent = `
    <div class="timeline-item in-line-loader">
        <div class="animated-background facebook">
           <div class="background-masker header-top"></div>
           <div class="background-masker header-left"></div>
           <div class="background-masker header-bottom"></div>
           <div class="background-masker subheader-left"></div>
           <div class="background-masker subheader-right"></div>
           <div class="background-masker subheader-bottom top30"></div>
           <div class="background-masker content-top"></div>
           <div class="background-masker content-first-end"></div>
        </div>
    </div>
`;

const flashComponent = function(item) {

	var template = $(`
		<div class="alert custom-alert" id="alert_${item.id}">
	      ${item.title}. &nbsp;&nbsp; <strong class="pointer" data-undo="${item.id}">UNDO</strong>
	    </div>
	`);

	template.find('[data-undo]').click( function() {

		if(item.type =='new_entry') {
			if(restorableRecord['new_entry_' + $(this).attr('data-undo')]) {
				restorableRecord['new_entry_' + $(this).attr('data-undo')].forEach(item => {						
					entry.deleteEntry(item.id);
				});	
			}
		}

		// callback after undo
		if(typeof item.afterUndo === "function") {
			item.afterUndo();
		}
	});



	return template;
}

const entry = {
	entries: [],
	create: function (obj) {
		return EntryCtrl.create(obj);
	},
	save: function (value) {
		localStorage.setItem("qleary_entry", JSON.stringify(value));
		sync2('');
	},
	save2: function (value) {
		localStorage.setItem("qleary_entry", JSON.stringify(value));
	},
	synced: function(ids) {
		ids.forEach(item => {
			entry.updateLocal(item, {}, false);
		});
	},
	lastSortable: function(columnId) {
		return EntryCtrl.lastSortable(columnId);
	},
	restoreSelf: function (id) {
		
		if(restorableRecord['entry_' + id]) {
			let obj2 = restorableRecord['entry_' + id];
			obj2.restore = true;
			entry.deleteRemovedEntry(id);
			let obj = entry.create(obj2);

			if(currentBoard.columns.instance.hasOwnProperty(restorableRecord['entry_' + id].column_id)){
				currentBoard.columns.instance[restorableRecord['entry_' + id].column_id].newEntry(obj);
			}
		}
	},
	restore: function (id) {

		if(restorableRecord['board_entry_' + id]) {

			if(restorableRecord['board_entry_' + id] instanceof Array) {
				restorableRecord['board_entry_' + id].map(function(item){
					entry.deleteRemovedEntry(item.id);
					item.restore = true;
					entry.create(item);
				});
			};
		}
	},
	restoreByColumn: function (id, timestamp='') {
		
		if(restorableRecord['columns_entry_' + id+timestamp]) {

			if(restorableRecord['columns_entry_' + id + timestamp] instanceof Array) {
				restorableRecord['columns_entry_' + id + timestamp].map(function(item){
					entry.deleteRemovedEntry(item.id);
					item.restore = true;
					entry.create(item);
				});
			};
		}
	},
	getRemovedItem: function () {
		if (!localStorage.getItem("qleary_entry_removed")) {
			return [];
		}
		return JSON.parse(localStorage.getItem("qleary_entry_removed"));
	},
	saveRemoved: function (value) {
		localStorage.setItem("qleary_entry_removed", JSON.stringify(value));
	},
	createRemoved: function (value) {
		let items = this.getRemovedItem();
		items.push(value);
		this.saveRemoved(items);
	},
	deleteRemovedEntry: function (id) {

		let data = this.getRemovedItem();
		let index = data.map(function (item) {
			return String(item.id);
		}).indexOf(String(id));
		if (index > -1) {
			data.splice(index, 1);
			
			this.saveRemoved(data);
		}
	},
	saveCurrestSession: function () {
		this.save(this.entries);
	},
	get: function () {
		if (!localStorage.getItem("qleary_entry")) {
			return this.entries = [];
		}
		return this.entries = JSON.parse(localStorage.getItem("qleary_entry"));
	},
	first: function (id) {
		this.get();

		var result = this.entries.filter(obj => {
			return obj.id == id;
		});
		if (result[0]) {
			return result[0];
		}
		return {};
	},
	count: function (columnId) {
		if (columnId) {
			return this.get().filter((obj, index) => {
				return (obj.column_id === columnId);
			}).length;
		}
		return this.get().length;
	},
	getSyncable: function (id) {
		return this.get().filter(obj => {
			return (obj.sync === true);
		});
	},

	getByColumn: function (id) {
		return (this.get().filter(obj => {
			return (obj.column_id === id);
		})).sort(function (a, b) {
			return (a.sortable || 0) - (b.sortable || 0);
		});
	},
	getByBoard: function (id) {
		return (this.get().filter(obj => {
			return (obj.board_id === id);
		})).sort(function (a, b) {
			return a.sortable - b.sortable;
		});
	},
	deleteEntry: function (id, sync) {

		sync = sync || 'sync';
		let index = this.get().map(function (item) {
			return String(item.id);
		}).indexOf(String(id));
		if (index > -1) {
			this.createRemoved(this.entries[index]);
			this.entries.splice(index, 1);
			if (sync == 'sync') {
				this.save(this.entries);
			} else {
				this.save2(this.entries);
			}
		}
	},
	deleteByBoard: function (obj) {

		entry.getByBoard(obj.id).forEach(function (item, index) {

			entry.deleteEntry(item.id, 'not_sync');

		});
	},
	removeByColumn: function (columnId) {

		entry.getByColumn(columnId).forEach(function (item, index) {

			entry.deleteEntry(item.id, 'not_sync');

		});
	},
	update: function (id, obj) {
		this.get();
		let index = getIndexById(entry.entries, id.trim());
		if (index === -1) {
			return false;
		}

		if (obj.hasOwnProperty("sortable")) {
			entry.entries[index].sortable = obj.sortable;
		}

		if (obj.hasOwnProperty("title")) {
			entry.entries[index].title = obj.title;
		}

		if (obj.hasOwnProperty("column_id")) {
			entry.entries[index].column_id = obj.column_id;
		}

		if (obj.hasOwnProperty("most_visited")) {
			entry.entries[index].most_visited += 1;
		}

		if (obj.hasOwnProperty("description")) {
			entry.entries[index].description = obj.description;
		}

		if (obj.hasOwnProperty("status")) {
			entry.entries[index].status = obj.status;
		}
		if (obj.hasOwnProperty("url")) {
			entry.entries[index].url = obj.url;
		}
		entry.entries[index].sync = true;

		this.save(entry.entries);
		return true;

	},
	updateLocal: function (id, obj, sync) {

		this.get();
		let index = getIndexById(entry.entries, id.trim());
		if (index === -1) {
			return false;
		}

		if (obj.hasOwnProperty("sortable")) {
			entry.entries[index].sortable = obj.sortable;
		}

		if (obj.hasOwnProperty("title")) {
			entry.entries[index].title = obj.title;
		}

		if (obj.hasOwnProperty("column_id")) {
			entry.entries[index].column_id = obj.column_id;
		}

		if (obj.hasOwnProperty("most_visited")) {
			entry.entries[index].most_visited += 1;
		}
		if (obj.hasOwnProperty("url")) {
			entry.entries[index].url = obj.url;
		}
		
		// if(sync === true) {
		entry.entries[index].sync = true;
		// }
		this.save2(entry.entries);
		return true;
	},
	createObject: function (obj) {
		if (!obj.hasOwnProperty('column_id')) {
			obj.column_id = '';
		}
		obj.type = obj.type || 'link';
		obj.sync = true;
		obj.sortable = obj.sortable || 0;
		return obj;
	}
};

const RSStorage = {
	get: function (key) {
		localStorage.getItem(key);
	},
	set: function (key, value) {
		localStorage.setItem(key, value);
	},
	getCurrentBoardId: function () {

		let id = null;

		if ($('.on-new-tab').length > 0) {

			if(localStorage.getItem("sync_board") == "false") {
				id = board.first(localStorage.getItem("board_for_new_tab"));
				if (id.hasOwnProperty('id')) {
					return id.id;
				}
			}

			id = board.favorite();
			if (id) {
				return id.id;
			}
		}
		id = board.first(localStorage.getItem('qleary_current_board'));

		if (id.hasOwnProperty('id')) {
			return id.id;
		} else {
			id = board.default();
			if (id) {
				this.setCurrentBoardId(id.id);
				id = id.id;
			}
		}
		return id;
	},
	setCurrentBoardId: function (value) {
		return localStorage.setItem('qleary_current_board', value);
	},
	createEntry: function (value) {
		return localStorage.setItem('qleary_entry', value);
	},
	getEntry: function () {
		return this.parseArray(localStorage.getItem('qleary_entry'));
	},
	parseArray: function (arr) {
		if (!arr) {
			return [];
		}
		return JSON.parse(arr);
	},
	setUser: function (data) {
		return localStorage.setItem('qleary_user', JSON.stringify(data));
	},
	getUser: function () {
		return JSON.parse(localStorage.getItem('qleary_user'));
	},
	logoutUser: function () {
		localStorage.removeItem('qleary_user');
		return true;
	}
};

var Columns = function (boardid, item) {
	this.boardid = boardid;
	this.item = item;
	this.columns = [];
	this.instance = {};
	this.getAll = function () {
		return this.columns = board.column(this.boardid);
	};

	this.render = function () {
		let _ = this;
		$('.column-container').find('.column-block').remove();
		$('#create_column_btn').before(
			this.getAll().map(function (item, $index) {
				_.instance[item.id] = new columnTemplate(item);
				return _.instance[item.id].render(item, $index);
			})
		);
		setTimeout(function () {
			$('#column_container').sortable({
				axis: "x",
				handle: ".dragable-element",
				placeholder: "ui-state-highlight col-sm-3 white_box",
				start: function (event, ui) {
					ui.item.addClass('tilt');
					tilt_direction(ui.item);
				},
				stop: function (e, ui) {
					ui.item.removeClass("tilt");
					_.getAll();

					$.map($(this).find('.column-block'), function (el) {

						let currentIndex = getIndexById(_.columns, $(el).attr('data-id'));

						let removedElement = _.columns.splice(currentIndex, 1)[0];
						removedElement.sync = "true";
						_.columns.splice($(el).index(), 0, removedElement);

						setTimeout(function () {
							board.updateAllColumn(_.boardid, _.columns);
						}, 100);

					});

				}
			});

			make_entry_sortable();

		}, 300);
	};

	this.createNewElement = function (item, index) {
		this.instance[item.id] = new columnTemplate(item);
		$('#create_column_btn').before(this.instance[item.id].render(item, index));
		make_entry_sortable();
		return this.instance[item.id];
	};

};

function reorderCards(element) {

	var ordarableIds = [];
	$.map($(element).find('.entry-block, .checklist-block'), function (el) {
		if($(el).attr('data-id')) {
			entry.updateLocal($(el).attr('data-id'), {
				'sortable': $(el).index()
			});
			ordarableIds.push($(el).attr('data-id'));
		}
	});

	setTimeout(function () { service.saveEntryOrder(ordarableIds); }, 500);

}
function make_entry_sortable() {

	$('.entry-list').sortable({
		connectWith: '.entry-list',
		placeholder: "ui-state-highlight list-group-item",
		start: function (event, ui) {
			ui.item.addClass('tilt');
			tilt_direction(ui.item);

			// var x = $(ui.item).position();
  			// console.log("Top: " + x.top + " Left: " + x.left);

			// var s = document.getElementsByClassName('makescroll')[0]
			// s.scrollLeft = x.left;

		},
		change: function(event, ui) {
            var x = $(ui.item).position();
  			// console.log("Top: " + x.top + " Left: " + x.left);

			// // $(".makescroll").animate({right: x.left+'px'});
			// var s = document.getElementsByClassName('makescroll')[0]
			// s.scrollLeft = x.left;			
			// $(".makescroll").animate({
			// 	scrollLeft: x.left
			// }, 1000);
        },
		stop: function (event, ui) {

			ui.item.removeClass('tilt');		

			if(this.id == ui.item.parent().attr('id')) {
				reorderCards(this);
			}
		},
		receive: function (event, ui) {

			let _ = this;

			if (ui.item.attr('data-id')) {

				entry.updateLocal(ui.item.attr('data-id'), {
					column_id: this.id,
					sortable: ui.item.index()
				});

				setTimeout(function () {
					service.createOrUpdateEntry(ui.item.attr('data-id'));
				}, 500);

				reorderCards(this);

			} else {

				if(currentSession.hasOwnProperty(ui.item.attr('data-tabid'))) {
					let data = currentSession[ui.item.attr('data-tabid')];

					if (data.title) {

						var data2 = currentBoard.createEntry({
							column_id: _.id,
							title: data.title,
							url: data.url,
							favIconUrl: 'https://www.google.com/s2/favicons?domain=' + data.url,
							sortable: ui.item.index()
						});


						ui.item.remove();
						if(localStorage.getItem("tab_status_on_save") == "true") {
							if(data.id) {
								chrome.tabs.remove(data.id);
							}
						}		
						if(data2 === false) {
							alert("The url you are trying to save is already added in the system.");
						}
						reorderCards(this);
					}
				}
			}
		}
	});
}

function tilt_direction(item) {
	var left_pos = item.position().left,
		move_handler = function (e) {
			if (e.pageX >= left_pos) {
				item.addClass("right");
				item.removeClass("left");
			} else {
				item.addClass("left");
				item.removeClass("right");
			}
			left_pos = e.pageX;
		};
	$("html").bind("mousemove", move_handler);
	item.data("move_handler", move_handler);
}

var currentBoard = {
	id: RSStorage.getCurrentBoardId(),
	detail: {},
	columns: null,
	activeColumn: null,
	col: {},
	action:'',
	init: function () {
		currentBoard.detail = board.first(currentBoard.id);
		this.columns = new Columns(currentBoard.id);
		this.columns.render();
		board.renderMenu();		
		if (!currentBoard.detail.name) {
			return;
		}
		$('#selected_board_name').val(currentBoard.detail.name.ucfirst());

		$('#make_favorite').removeAttr('checked');
		if(currentBoard.detail.favorite == 1) {
			$('#make_favorite').attr('checked', 'false')
		}
		document.title = currentBoard.detail.name.ucfirst();

		if(auth.isLoggedIn()) {
			if(currentBoard.detail.hasOwnProperty('user_id')) {
				if(userId !== currentBoard.detail.user_id) {
					$('#share_board_btn').hide();
				}
			}
		}
	},
	createColumn: function (param) {
		let newColumn = board.createNewColumn(currentBoard.id, param);
		return this.columns.createNewElement(newColumn.obj, newColumn.index);
	},
	updateColumn: function (columnid, obj) {
		board.updateColumn(columnid, obj);
	},
	createEntry: function (obj) {
		obj.board_id = this.id;
		if (!obj.hasOwnProperty('column_id')) {
			obj.column_id = this.activeColumn;
		}
		obj.created_at = (new Date()).toMysqlFormat();
		obj = entry.create(obj);
		
		if(obj === false) { return false; }

		if (!this.col.hasOwnProperty(obj.column_id)) {
			this.col[obj.column_id] = {};
		}
		this.col[obj.column_id][obj.id] = new Col(obj.column_id);
		var obj2 = this.col[obj.column_id][obj.id].newEntry(obj);
		
		service.createOrUpdateEntry(obj.id);

		return obj2;
	},
	createNote: function (obj) {
		obj.type = 'note';
		obj.title = '';
		this.createEntry(obj).editBtn.trigger('click');
	},
	updateEntry: function () {

	},
	deleteColumn: function (id) {
		return board.deleteColumn(id, currentBoard.id);
	},
	createCheckList: function(obj) {
		obj.type = 'checklist';
		this.createEntry(obj).editBtn.trigger('click');
		return obj;
	}
};

let Col = function (id) {
	this.detail = board.getCoumn(id);
	this.entry = {};
	this.container = $('#column_' + id);
	this.newEntry = function (item) {
		this.entry[item.id] = new EntryController(item);
		let tpl = this.entry[item.id].render();

		if(item.hasOwnProperty('sortable')) {
			
			if(item.sortable == 0 && this.container.find(`.entry-list li` ).length > 0) {
				this.container.find(`.entry-list li:eq(${item.sortable})` ).after(tpl);
			} else if(this.container.find(`.entry-list li:eq(${item.sortable - 1})` ).length){
				this.container.find(`.entry-list li:eq(${item.sortable - 1})` ).after(tpl);
			} else {
				this.container.find('.entry-list').append(tpl);
			}
		} else {
			this.container.find('.entry-list').append(tpl);
		}
		currentBoard.columns.instance[item.column_id].reloadEntryCount();
		return this.entry[item.id];
	}

};

const EntryController = function (item) {
	this.item = item || {};
	this.tpl = null;
	this.editBtn = null;
	this.delBtn = null;

	this.render = function () {
		this.item.type = this.item.type || 'link';
		if(this.item.type == 'link') {
			return this.linkRender();
		} else if(this.item.type == 'note') {
			return this.renderNote();
		} else if(this.item.type == 'rss') {
			return this.renderRSS();
		} else if(this.item.type == 'checklist') {
			return this.checkList();
		}
	}

	this.renderRSS = function() {
		let _ = this;

		let data = {
			title: _.item.title,
			url: _.item.permalink,
			favIconUrl: 'https://www.google.com/s2/favicons?domain=' + _.item.permalink
		};
		_.tpl = $(`<li class="list-group-item entry-block ui-state-default" data-type="rss" ></li>`);
		let container = $(`<div></div>`);

		container.append(`<a class="fullLi" href="${_.item.permalink}" target="_blank"></a>
			<div class="d-flex justify-content-between align-content-center mb-2">
          		<div><div class="postcount">${_.item.sno}</div></div>
          		<div class="col-sm-12 py-1">
              		<p class=" entryTitle m-0 ">${_.item.title}</p>
              		<small class="text-muted smallDec"></small>
              	</div>
        	</div>`
        );

        _.tpl.append(container);
        return _.tpl;
	}

	this.renderNote = function () {
		let _ = this;

		let url = chrome.extension.getURL('note.html?id=' + _.item.id);
		this.tpl = $(`<li class="list-group-item entry-block ui-state-default note-block" data-id="${_.item.id}"></li>`);
		let container = $(`<div></div>`);

		container.append(`<a class="fullLi pointer url-click" target="${urlTarget}"></a>
			<div class="d-flex align-content-center">
	           <div class="py-2 px-0 mr-auto">
	              <p class=" entryTitle m-0 py-1">${_.item.title || "New Note"}</p>
	           </div>
           		<div class="dropdown action dropleft position-relative" style="z-index:2;">
					<a class="pointer" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
						<div class="cardaction"><span></span><span></span><span></span></div>
					</a>
						<div class="dropdown-menu board-action controls" aria-labelledby="dropdownMenuLink"></div>
				</div>
        	</div>`
        );

		container.find('.url-click').click(function(){
			entryDetail = _.item;
			$('#note_title').val((entryDetail.title || '').ucfirst());
			$('#note_body').val((entryDetail.description || '').ucfirst());
			$('#edit_note_model').modal('show');
			entryObject = function(title, description){
				_.item.title = title;
				_.item.description = description;
				container.find('.entryTitle').html(title);
			}
		});

		let editForm = $(`<div class="hidden hiddenInput">
			<input type="text" name="entry_name" placeholder="New Note" maxlength="110" class="note-editor" autocomplete="entry_name">
		</div>`);

		this.editBtn = $(`<a class="dropdown-item link-hover"><img src="asset/image/menu_createnote_icon.png"> Edit</a>`);
		this.editBtn.click(function () {
			editForm.show();
			editForm.find("input").val(_.item.title).focus();

			container.hide();
		});

		editForm.find("input").blur(function () {
			_.item.title = this.value;
			entry.update(_.item.id, {
				"title": this.value
			});
			editForm.hide();
			container.show();
			container.find('.entryTitle').html(this.value || "New Note");
		});

		editForm.find("input").keyup(function (evt) {
			if (evt.keyCode == 13) {
				$(this).blur();
			}
		});

		let delBtn = $(`<a class="dropdown-item link-hover"><img src="asset/image/delete.png" > Delete </a>`);
		// let delBtn = $(`<a class="link-hover"><img src="asset/image/delete_icon.png"></a>`);
		delBtn.click(function () {

			let undoHtml = $(`<div class="alert alert-success custom-alert" id="alert_${_.item.id}">
	          Remove Complete. &nbsp;&nbsp; <strong class="pointer" data-undo="${_.item.id}" data-undotype="entry">UNDO</strong>
	        </div>`);
			message.prepend(undoHtml);
			setTimeout(function(){
				undoHtml.remove();
			}, 10000);

	        restorableRecord['entry_' + _.item.id] = _.item;
			entry.deleteEntry(_.item.id);
			_.tpl.remove();
			currentBoard.columns.instance[_.item.column_id].reloadEntryCount();
		});

		this.tpl.append(container);
		let controls = this.tpl.find('.controls');

		this.tpl.append(editForm);
		controls.append(this.editBtn)
		this.createDuplicateBtn();
		controls.append(delBtn);

		return this.tpl;
	}

	this.linkRender = function () {
		let _ = this;

		let editForm = $(`<div class="hidden hiddenInput">
			<input type="text" name="entry_name" value="${_.item.title}" autocomplete="entry_name">
		</div>`);

		let container = $('<div></div>');
		let editBtn = $(`<a class="dropdown-item link-hover"><img src="asset/image/pencil_icon1.png"> Rename</a>`);

		editBtn.click(function () {
			editForm.show();
			editForm.find("input").focus();
			container.hide();
		});

		editForm.find("input").blur(function () {
			entry.update(_.item.id, {
				"title": this.value
			});
			editForm.hide();
			container.show();
			container.find('.entryTitle').html(this.value);
			_.item.title = this.value;
		});

		editForm.find("input").keyup(function (evt) {
			if (evt.keyCode == 13) {
				$(this).blur();
			}
		});

		this.delBtn = $(`<a class="dropdown-item link-hover"><img src="asset/image/delete.png" > Delete </a>`);
		this.delBtn.click(function () {

			let undoHtml = $(`<div class="alert alert-success custom-alert" id="alert_${_.item.id}">
	          Remove Complete. &nbsp;&nbsp; <strong class="pointer" data-undo="${_.item.id}" data-undotype="entry">UNDO</strong>
	        </div>`);
			message.prepend(undoHtml);
			setTimeout(function(){ undoHtml.remove(); }, 10000);

	        restorableRecord['entry_' + _.item.id] = _.item;
			entry.deleteEntry(_.item.id);
			_.tpl.remove();

			currentBoard.columns.instance[_.item.column_id].reloadEntryCount();

		});
		this.tpl = $(`<li class="list-group-item entry-block ui-state-default" data-id="${_.item.id}"></li>`);

		container.append(`
			<a class="fullLi url-click" href="${_.item.url}" target="${urlTarget}"></a>
			<div class="d-flex align-content-center">	     
				<div class="iconsleft pr-2 align-items-center d-flex">
					<img src="${_.item.favIconUrl}" height="15" on-error="asset/image/default_favicon.png">
				</div>   
	           <div class="py-2">
	              <p class=" entryTitle m-0 py-1 text-truncate">${_.item.title}</p>	      
	           </div>

				<div class="dropdown action dropleft position-relative" style="z-index:2;">
					<a class="pointer" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
						<div class="cardaction"><span></span><span></span><span></span></div>
					</a>
						<div class="dropdown-menu board-action controls" aria-labelledby="dropdownMenuLink">
							
						</div>
				</div>	           
	        </div>
	    `);

		container.find('.url-click').click(openUrl.bind(this));
		
		container.find('.action').on('show.bs.dropdown', function () {
		  	_.tpl.addClass('open-action-bar');
		})

		container.find('.action').on('hidden.bs.dropdown', function () {
		  	_.tpl.removeClass('open-action-bar');
		})

		// container.find('[on-error]').on('error', function(){
		// 	$(this).attr('src', $(this).attr('on-error'));
		// });

		this.tpl.append(container);
		let controls = this.tpl.find('.controls');
	
		this.tpl.append(editForm);		
		controls.append(editBtn)
		this.createRenameBtn();
		controls.append(this.delBtn);

		return this.tpl;
	}

	this.createRenameBtn = function () {
		var _ = this;
		this.rename = $(`<a class="dropdown-item link-hover"><img src="asset/image/menu_createnote_icon.png"> Edit</a>`);
		this.rename.click( function() {

			$('#edit_entry_title').val(_.item.title);
			$('#edit_website_url').val(_.item.url);
			$('#edit-bookmark').modal('show');

			editableBookmarkObject = _.item;
			editableBookmarkObject.updationDone = (param) => {
				_.item.title = param.title;
				_.item.url = param.url;
				_.tpl.find('.entryTitle').html(_.item.title);
				_.tpl.find('[name="entry_name"]').val(_.item.title);
				_.tpl.find('a.url-click').attr('href', _.item.url);
			}
			editableBookmarkObject.remove = () => {
				_.delBtn.trigger('click');
			};
		});

		this.tpl.find('.controls').append(this.rename);
	}

	this.createDuplicateBtn = function () {
		var _ = this;
		this.duplicate = $(`<a class="dropdown-item link-hover"><img src="asset/image/menu_duplicate_icon.png"> Duplicate</a>`);
		this.duplicate.click( function(){

			var item = EntryCtrl.first(_.item.id);
			var lastIndex = entry.lastSortable(item.column_id);
			
			var obj = currentBoard.createEntry({
				title: item.title + ' copy',
				url: item.url,
				column_id: item.column_id,
				type: item.type,
				description: item.description,
				sortable: lastIndex + 2,
				favIconUrl: item.favIconUrl
			});
		});

		this.tpl.find('.controls').append(this.duplicate);
	}

	this.checkList = function () {
		let _ = this;


		let container = $('<div></div>');
		this.tpl = $(`<li class="list-group-item checklist-block ui-state-default" data-id="${_.item.id}"></li>`);

		let checkedStatus = ((_.item.status == 2)? 'checked="checked"' : '');

		container.append(`
			<div class="d-flex align-content-center">	     
				<div class="iconsleft pr-2 align-items-center d-flex">
					<span class="lTCheck">
						<input autocomplete="off" type="checkbox" class="complete" ${checkedStatus} >
						<svg class="checkmark " xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 35" style="transform: scale(.8);">
							<polyline fill="none" stroke="#2f58e8" stroke-width="6" stroke-linecap="round" stroke-miterlimit="10" points="36.063,2.5   13.411,29.621 2.5,19.229"></polyline>
						</svg>						
					</span>
				</div>   
	           <div class="py-2">
	              <input type="text" value="${_.item.title}" placeholder="New Task" class="input-field transparent font15" autocomplete="new_task_title">
	           </div>	           
	           <div class="dropdown action dropleft position-relative" style="z-index:2;">
					<a class="pointer controls" role="button"></a>
				</div>
	        </div>
	        `);

		container.find('.complete').click(function () {			
			entry.update(_.item.id, {
				"status": (($(this).is(':checked'))? 2 : 0)
			});
			container.find('.input-field').removeClass("taskCompleted");
			if($(this).is(':checked')) {
				container.find('.input-field').addClass("taskCompleted");
			}
			
		});
		if(_.item.status == 2) {
			container.find('.input-field').addClass("taskCompleted");
		}
		container.find('.input-field').keyup(function (evt) {
			if (evt.keyCode == 13) {
				$(this).blur();
			}
		})
		.blur(function () {
			entry.update(_.item.id, {
				"title": this.value
			});
		});

		this.editBtn = $(`<a class="dropdown-item link-hover"><img src="asset/image/menu_createnote_icon.png"> Edit</a>`);
		this.editBtn.click(function () {
			container.find('.input-field').focus();
		});

		this.tpl.append(container);
		

		this.delBtn = $(`<div class="cardaction"><img class="w-50" src="asset/image/delete.png" /></div>`);
		this.delBtn.click(function () {
			let undoHtml = $(`<div class="alert alert-success custom-alert" id="alert_${_.item.id}">
				Remove Complete. &nbsp;&nbsp; <strong class="pointer" data-undo="${_.item.id}" data-undotype="entry">UNDO</strong>
			</div>`);
			message.prepend(undoHtml);
			setTimeout(function(){ undoHtml.remove(); }, 10000);

			restorableRecord['entry_' + _.item.id] = _.item;
			entry.deleteEntry(_.item.id);
			_.tpl.remove();

			currentBoard.columns.instance[_.item.column_id].reloadEntryCount();
			
		});		
		this.tpl.find('.controls').append(this.delBtn);

		
		return this.tpl;
	}


	this.createRemoveBtn = function () {
		var _ = this;
		this.delBtn = $(`<img class="w-50" src="asset/image/delete.png" >`);
		this.delBtn.click(function () {

			let undoHtml = $(`<div class="alert alert-success custom-alert" id="alert_${_.item.id}">
	          Remove Complete. &nbsp;&nbsp; <strong class="pointer" data-undo="${_.item.id}" data-undotype="entry">UNDO</strong>
	        </div>`);
			message.prepend(undoHtml);
			setTimeout(function(){
				undoHtml.remove();
			}, 10000);

	        restorableRecord['entry_' + _.item.id] = _.item;
			entry.deleteEntry(_.item.id);
			_.tpl.remove();

			currentBoard.columns.instance[_.item.column_id].reloadEntryCount();

		});

		this.tpl.find('.controls').append(this.delBtn);
	}


};


let columnTemplate = function (column) {
	this.form = null;
	this.entry = null;
	this.newColumnBtn = null;
	this.item = null;
	this.index = null;
	this.tpl = null;

	this.render = function(item, index) {

		this.item = item;
		this.index = index;

		if(item.type == 'checklist') {
			return this.checkListTpl(item, index);
		} else if(item.type == 'rss') {
			return this.rssFeedTpl(item, index);
		} else {
			return this.linksTpl(item, index);
		}
	}
	this.updateColumnForm = function() {
		let _ = this;

		this.form = document.createElement('input');
		this.form.classList.add('column-input');
		this.form.value = _.item.name;
		
		this.form.onblur = function () {
			currentBoard.updateColumn(column.id, {
				"name": this.value
			});
		};

		this.form.onkeyup = function (evt) {
			if (evt.keyCode == 13) {
				$(_.form).blur();
			}
		};

	}

	this.createTaskComponent = function() {
		let _ = this;
		this.createTaskBtn = $('<a class="dropdown-item create-task" href="#"><img src="asset/image/menu_task_icon.png"> Create Task</a>');
		this.createTaskBtn.click(function () {
			
			var lastIndex = entry.lastSortable(_.item.id);
			currentBoard.activeColumn = _.item.id;

			currentBoard.createCheckList({
				title: '',
				sortable: ++lastIndex + 1

			});

		});
	}

	this.moveColumnComponent = function() {
		let _ = this;
		this.moveBtn = $('<a class="dropdown-item" href="#"><img src="asset/image/menu_move_icon.png"> Move To</a>');
		this.moveBtn.click(function () {
			currentBoard.activeColumn = _.item.id;
			currentBoard.action = 'move';
			$('#board_list').modal('show');
		});
	}

	this.copyColumnComponent = function() {
		let _ = this;
		this.copyBtn = $('<a class="dropdown-item" href="#"><img src="asset/image/menu_duplicate_icon.png"> Duplicate</a>');
		this.copyBtn.click(function () {
			currentBoard.action = 'copy';
			currentBoard.activeColumn = _.item.id;
			$('#board_list').modal('show');
		});
	}

	this.deleteComponent = function() {
		let _ = this;
		this.delete = $('<a class="dropdown-item" href="#"><img src="asset/image/delete.png"> Delete Column</a>');
		this.delete.click(function () {

			let undoHtml = $(`<div class="alert alert-success custom-alert" id="alert_${_.item.id}">
	          Remove Complete. &nbsp;&nbsp; <strong class="pointer" data-undo="${_.item.id}" data-boardid="${currentBoard.id}" data-undotype="column">UNDO</strong>
	        </div>`);
	        message.prepend(undoHtml);
			setTimeout(function(){
				undoHtml.remove();
			}, 10000);

			restorableRecord['column_' + _.item.id] = _.item;
			restorableRecord['columns_entry_' + _.item.id] = entry.getByColumn(_.item.id);

			if (currentBoard.deleteColumn(_.item.id)) {
				_.tpl.remove();
			}

		});
	}

	this.deleteAllComponent = function() {
		let _ = this;
		this.deleteAll = $('<a class="dropdown-item" href="#"><img src="asset/image/menu_alltabs_icon.png"> Delete All Tabs</a>');
		this.deleteAll.click(function () {

			let undoHtml = $(`<div class="alert alert-success custom-alert" id="alert_${_.item.id}">
	          Remove Complete. &nbsp;&nbsp; <strong class="pointer" data-undo="${_.item.id}" data-boardid="${currentBoard.id}" data-undotype="multiple_entry">UNDO</strong>
	        </div>`);
	        message.prepend(undoHtml);
			setTimeout(function(){ undoHtml.remove(); }, 10000);

			restorableRecord['columns_entry_' + _.item.id] = entry.getByColumn(_.item.id);
			entry.removeByColumn(_.item.id);
			currentBoard.columns.instance[_.item.id].reloadEntryCount().renderEntries();
			service.removeEntry();

		});
	}

	this.syncFromMobileComponent = function() {
		let _ = this;
		this.mobileSync = $('<a class="dropdown-item" href="#"><img src="asset/image/menu_alltabs_icon.png"> Sync from mobile</a>');
		this.mobileSync.click(function () {

			if(!auth.isLoggedIn()) {
				alert('Please login first!');
				return;
			}
			$('.big-centered-loader').show();
			serviceController.get( serviceController.version + 'entry?id=' + auth.user().id ).then((result) => {
				
				$('.big-centered-loader').hide();						

				let allEntries = entry.getByColumn(_.item.id);
				var lastIndex = entry.lastSortable(_.item.id);

				result.entry.forEach(item => {

					if(allEntries.filter(row => { return row.url == item.url }).length > 0) {
						return;
					}

					lastIndex++;
					currentBoard.createEntry({
						title: item.title,
						column_id: _.item.id,
						url: item.url,
						sortable: lastIndex,
						favIconUrl: 'https://www.google.com/s2/favicons?domain=' + item.url,						
					})

				});
			});
			 

		});
	}

	this.rssSelectedComponent = function() {
		let _ = this;

		let selected = localStorage.getItem('qlearly_rss_' + this.item.id);
		this.loader = $('<div class="small-loader select-box-loader hide"></div>');
		this.select = $('<select class="form-control"  autocomplete="off" ></select>');
		this.select.append(`
			<option value="">Select Channel</option>
			<option value="behance" data-color="#003ECB">Behance</option>
			<option value="businessinsider">Business Insider</option>
			<option value="product-hunt">Product Hunt</option>
			<option value="designernews">Designer News</option>
			<option value="techcrunch">TechCrunch</option>
			<option value="wired">Wired</option>
		 	<option value="medium">Medium</option>
		 	<option value="hacker-news">Hacker News</option>
		 	<option value="theverge">The Verge</option>
		 	<option value="mashable">Mashable</option>
		 	<option value="thenextweb">The Next Web</option>
		`);

		this.select.find('[value="' + selected + '"]').attr('selected', "selected");


		this.select.change(function(evt){
			
			_.entry.html('');
			if(this.value != '') {
				for(var i = 0; i< 5; i++) {
					_.entry.append('<li class="list-group-item">' + loaderComponent + '<li>');
				}
				_.loader.show();
				localStorage.setItem('qlearly_rss_' + _.item.id, this.value);

				_.tpl.attr('data-rsstype', this.value);
				service.get( service.version + 'rss-feed/' + this.value + '?sort=' + _.selectOrder.val()).then(function (response) {
					_.loader.hide();
					_.entry.html('');
					if(response.success == true) {
						response.data.feed.forEach((feed, index) => {
							feed.type = 'rss';
							feed.sno = index + 1;
							_.entry.append((new EntryController(feed)).render());
						});

						make_entry_sortable();
					}
				});
			}

		});
	}

	this.rssOrderComponent = function() {
		let _ = this;

		this.selectOrder = $('<select class="form-control"  autocomplete="off"></select>');
		this.selectOrder.append(`
			<option value="latest">Latest</option>
			<option value="popular">Popular</option>
		`);
		this.selectOrder.change( function(evt) {
			_.select.trigger('change');
		});
	}


	this.rssFeedTpl = function( item, index ) {
		let _ = this;
		item.type = item.type || 'link';		

		this.updateColumnForm();

		this.deleteComponent();

		this.rssOrderComponent();

		this.rssSelectedComponent();

		this.tpl = $(`<div class="dragable-element col-sm-3 ui-state-default widthSec column-block px-2" id="column_${item.id}" data-id="${item.id}" data-rsstype="product-hunt">
           <div class="white_box fullheight dragable-element">
           	<div>
              <div class="d-flex justify-content-between">
                <div>
                    <h4 class="text-uppercase mb-1">
                    <div class="form-container"></div>
                    </h4>
                    <span class="text-grey mb-3 entry-count">${entry.count(item.id)} Entry</span>
                 </div>
                 <div class="text-right">                 	
				    <div class="dropdown dropleft">
				        <a class="pointer" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				          <div class="dotted_menu">
				            <span></span><span></span><span></span>
				          </div>
				        </a>
				        <div class="dropdown-menu board-action" aria-labelledby="dropdownMenuLink" style="left: -20px!important;">
				        </div>
				    </div>
				    
				 </div>
              </div>
              	<div class="clearfix pt-3">
              		<div class="row px-2 newbtngroup">
              			<div class="col-8 pl-1 pr-0 select-component" ></div>
              			<div class="col-4 pl-1 pr-0 order-component" ></div>
              		</div>				  
				</div>
			</div>
              <ul class="list-group list-group-flush mt-1 board_data rss-list entry-list" id="${item.id}">
              </ul>
           </div>
        </div>`).find('.form-container').append(this.form).end();

		let entryCount = entry.count(item.id);
		this.tpl.find('.entry-count').html(`${entryCount} Entry`);
		if (entryCount > 1) {
			this.tpl.find('.entry-count').html(`${entryCount} Entries`);
		}

		this.tpl.find('.order-component').append(this.selectOrder);
		this.tpl.find('.select-component').append(this.select);
		this.loader.insertBefore(this.select);
		this.entry = this.tpl.find('.rss-list');
		this.boardAction = this.tpl.find('.board-action');
		this.boardAction.append(this.delete);

		this.select.trigger('change');

		return this.tpl;
	}

	this.saveSessionComponent = function() {

	}

	this.linksTpl = function (item, index) {
		let _ = this;
		item.type = item.type || 'link';	

		this.openAll = $(`<button class="btn theme_btn btn-block open-all">Open</button>`);
		this.note = $('<a class="dropdown-item create-note" href="#"><img src="asset/image/menu_createnote_icon.png"> Create Note</a>');

		this.updateColumnForm();

		this.moveColumnComponent();

		this.copyColumnComponent();

		this.createTaskComponent();

		this.deleteAllComponent();

		this.syncFromMobileComponent();

		this.deleteComponent();
		
		this.saveSessionBtn = $(`<button class="btn theme_btn btn-block save-tabs-on-board-btn">Save</button>`);
		this.saveSessionBtn.click(function () {

			chrome.tabs.query({ pinned: true, currentWindow: true}, function(pinnedTabs){

				chrome.tabs.query({ active: true, currentWindow: true }, function (curretnTabs) {

					var lastIndex = entry.lastSortable(item.id);

					curretnTabs = curretnTabs[0];
					chrome.tabs.query({ currentWindow: true, pinned: false }, function (tabs) {

						if(chrome.extension.getBackgroundPage().savePinnedTab()) {
							tabs = pinnedTabs.concat(tabs);
						}

						var allEntries = [];
						tabs.forEach(function (tab) {

							if (!tab.url || tab.url == 'chrome://newtab/' || tab.url.search(new RegExp(currentExtUrl, 'i')) > -1) {
								return false;
							}

							if (tab.id != curretnTabs.id) {
								++lastIndex;
								var entryObj = entry.create({
									board_id: currentBoard.id,
									column_id: item.id,
									title: tab.title,
									url: tab.url,
									favIconUrl: 'https://www.google.com/s2/favicons?domain=' + tab.url,
									sortable: lastIndex
								});

								if(entryObj) {
									allEntries.push(entryObj);
								}

								if(localStorage.getItem("tab_status_on_save") == "true") {
									chrome.tabs.remove(tab.id);
								}
							}
						});

						setTimeout(function () {

							if(allEntries.length > 0) {
								service.createOrUpdateMultipleEntry(allEntries);
								_.entry.html('');
								entry.getByColumn(item.id).forEach(eitem => {
									_.entry.append((new EntryController(eitem)).render());
								});

								_.reloadEntryCount();
							}

						}, 100);

					});

				});
			});

		});

		this.newColumnBtn = $(`<button class="btn theme_btn btn-block">Add</button>`);
		this.newColumnBtn.click(function () {
			if(item.type == 'link') {
				currentBoard.activeColumn = item.id;
				$('#createNew').modal('show');
			} else if(item.type == 'note') {
				_.note.trigger('click');
			}
		});

		this.note.click(function(){
			var lastIndex = entry.lastSortable(item.id);
			currentBoard.activeColumn = item.id;
			currentBoard.createNote({
				column_id: currentBoard.activeColumn,
				sortable: ++lastIndex + 1
			});
		})

		this.importExport = $('<a class="dropdown-item" href="#"><img src="asset/image/export.png"> Bulk Edit</a>');

		this.importExport.click(function(){
			currentBoard.activeColumn = item.id;
			$('#import_export_model').modal('show');
		});

		this.share = $('<a class="dropdown-item pointer"><img src="asset/image/menu_share_icon.png"> Share</a>');
		this.share.click(function () {

			currentBoard.action = 'column';
			if (!auth.isLoggedIn()) {
				$('.open-signup').trigger('click');
				return;
			}
			selColumnUsers = [];
			selectedColumn = item;

			let items = (board.getCoumn(item.id));
			if (items) {
				selectedColumn = items;
			}

			defualtSharableLink();
			if (selectedColumn.sharable_code) {
				changeSharableLink(selectedColumn.sharable_code);
			}
			selColumnUsers.push({
				'name': auth.user().name,
				'email': auth.user().email,
				'status': 'accepted'
			});

			addUserToSharableList(selColumnUsers);
			var share_column_2 = $('#share_column_2');
			share_column_2.modal('show');
			share_column_2.find('.selected_collection').html('Share column "' + item.name + '"');

			$('#seo_author').val(selectedColumn.author);
			$('#seo_made_by_url').val(selectedColumn.author_url);
			$('#seo_title').val(selectedColumn.meta_title);
			$('#seo_description').val(selectedColumn.meta_description);
			$('#sharable_code').val(selectedColumn.sharable_code);
			$('#seo_image_preview').attr('src', selectedColumn.image);

			$('#seo_image_container').removeClass('blank');
			if(!selectedColumn.image) {
				$('#seo_image_container').addClass('blank');
			}

		});


		this.tpl = $(`<div class="dragable-element col-sm-3 ui-state-default widthSec column-block px-2" id="column_${item.id}" data-id="${item.id}">
           <div class="white_box fullheight dragable-element">
           	<div>
              <div class="d-flex justify-content-between">
                <div>
                    <h4 class="text-uppercase mb-1">
                    <div class="form-container"></div>
                    </h4>
                    <span class="text-grey mb-3 entry-count">${entry.count(item.id)} Entry</span>
                 </div>
                 <div class="text-right">                 	
				    <div class="dropdown dropleft">
				        <a class="pointer" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				          <div class="dotted_menu">
				            <span></span><span></span><span></span>
				          </div>
				        </a>
				        <div class="dropdown-menu board-action" aria-labelledby="dropdownMenuLink" style="left: -20px!important;">
				        </div>
				    </div>
				    
				 </div>
              </div>
              	<div class="clearfix pt-3">
              		<div class="row px-2 newbtngroup">
              			<div class="col-4 pl-1 pr-0 new-entry-modal-btn"></div>
              			<div class="col-4 px-1 save-session-btn"></div>
              			<div class="col-4 pr-1 pl-0 openall-btn"></div>
              		</div>				  
				</div>
			</div>
              <ul class="list-group list-group-flush mt-1 board_data entry-list" id="${item.id}">
              </ul>
           </div>
        </div>`).find('.form-container').append(this.form).end();

		let entryCount = entry.count(item.id);
		this.tpl.find('.entry-count').html(`${entryCount}&nbsp;Entry`);
		if (entryCount > 1) {
			this.tpl.find('.entry-count').html(`${entryCount}&nbsp;Entries`);
		}

		this.tpl.find('.new-entry-modal-btn').append(this.newColumnBtn);
		this.tpl.find('.save-session-btn').append(this.saveSessionBtn);
		this.tpl.find('.openall-btn').append(this.openAll);
		this.entry = this.tpl.find('.entry-list');
		this.boardAction = this.tpl.find('.board-action');

		this.boardAction.append(this.createTaskBtn);
		if(item.type == 'link') {
			this.boardAction.append(this.note);
		}
		this.boardAction.append(this.delete).append(this.deleteAll);
		if(item.type == 'link') {
			this.boardAction.append(this.copyBtn);
			this.boardAction.append(this.importExport)
				.append(this.mobileSync);
			
			this.boardAction.append(this.moveBtn);
			if(currentBoard.detail.hasOwnProperty('user_id')) {
				if(userId === currentBoard.detail.user_id) {
					this.boardAction.append(this.share);
				}
			} else {
				this.boardAction.append(this.share);
			}
		}
		

		this.openAll.click(function () {
			entry.getByColumn(item.id).forEach(eitem => {
				if(eitem.type == 'link') {
					chrome.tabs.create({ url: eitem.url });
				}
			});
		});

		entry.getByColumn(item.id).forEach(eitem => {
			_.entry.append((new EntryController(eitem)).render());

		});
		return this.tpl;
	}


	this.checkListTpl = function(item, index) {
		let _ = this;

		this.updateColumnForm();

		this.deleteComponent();

		this.createTaskComponent();

		this.showCompleteBtn = false;
		this.completeBtn = $(`<button class="btn theme_btn btn-block">Hide complete</button>`);
		this.completeBtn.click(function () {
			if(_.showCompleteBtn == false) {
				_.showCompleteBtn = true;
				_.completeBtn.html('Show Complete');
				_.entry.html('');
				entry.getByColumn(item.id).forEach(eitem => {
					if(eitem.hasOwnProperty('status')) {
						if(eitem.status == 2) {
							return false;
						}
					}
					_.entry.append((new EntryController(eitem)).render());
				});

			} else {
				_.showCompleteBtn = false;
				_.completeBtn.html('Hide Complete');
				_.entry.html('');
				entry.getByColumn(item.id).forEach(eitem => {
					_.entry.append((new EntryController(eitem)).render());
				});
			}
		});

		this.newBtn = $(`<button class="btn theme_btn btn-block">Add</button>`);
		this.newBtn.click(function () {
			currentBoard.activeColumn = item.id;

			currentBoard.createCheckList({
				title: ''
			});
		});

		this.clearAll = $(`<button class="btn theme_btn btn-block open-all">Clear all</button>`);
		this.clearAll.click(function(){

			_.entry.html('');
			
			var allCheckList = entry.getByColumn(item.id).filter(eitem => {
				if(eitem.hasOwnProperty("type") && eitem.type === 'checklist') {
					return true;
				}
				return false;
			});

			if(allCheckList.length > 0) {

				var id = guid();
				let undoHtml = $(`<div class="alert alert-success custom-alert" id="alert_${item.id}">
		          Remove All. &nbsp;&nbsp; <strong class="pointer" data-undo="${item.id}" data-undotype="multiple_entry" data-timestamp="${id}">UNDO</strong>
		        </div>`);

		        message.prepend(undoHtml);
				setTimeout(function(){ undoHtml.remove(); }, 10000);
		        
				restorableRecord['columns_entry_' + item.id + id] = allCheckList;
			}


			entry.getByColumn(item.id).forEach(eitem => {
				if(eitem.type === 'checklist') {
					entry.deleteEntry(eitem.id);
					return false;
				}
				_.entry.append((new EntryController(eitem)).render());
			});

			_.reloadEntryCount();

		});

		this.importExport = $('<a class="dropdown-item" href="#">Import & Export</a>');

		this.importExport.click(function(){
			currentBoard.activeColumn = item.id;
			$('#import_export_model').modal('show');
		});

		this.share = $('<a class="dropdown-item" href="#">Share Column</a>');
		this.share.click(function () {
			if (!auth.isLoggedIn()) {
				$('.open-signup').trigger('click');
				return;
			}
			selColumnUsers = [];
			selectedColumn = item;


			let items = (board.getCoumn(item.id));
			if (items) {
				selectedColumn = items;
			}

			defualtSharableLink();
			if (selectedColumn.sharable_code) {
				changeSharableLink(selectedColumn.sharable_code);
			}
			selColumnUsers.push({
				'name': auth.user().name,
				'email': auth.user().email,
				'status': 'accepted'
			});

			addUserToSharableList(selColumnUsers);
			var share_column_2 = $('#share_column_2');
			share_column_2.modal('show');
			share_column_2.find('.selected_collection').html('Share column "' + item.name + '"');
		});

		this.tpl = $(`<div class="dragable-element col-sm-3 ui-state-default widthSec column-block px-2" id="column_${item.id}" data-id="${item.id}">
           <div class="white_box fullheight dragable-element">
           	<div>
              <div class="d-flex justify-content-between">
                <div>
                    <h4 class="text-uppercase mb-1">
                    <div class="form-container"></div>
                    </h4>
                    <span class="text-grey mb-3 entry-count">${entry.count(item.id)} Entry</span>
                 </div>
                 <div class="text-right">                 	
				    <div class="dropdown dropleft">
				        <a class="pointer" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				          <div class="dotted_menu">
				            <span></span><span></span><span></span>
				          </div>
				        </a>
				        <div class="dropdown-menu board-action" aria-labelledby="dropdownMenuLink" style="left: -20px!important;">
				        </div>
				    </div>
				    
				 </div>
              </div>
              	<div class="clearfix pt-3">
              		<div class="row px-2 newbtngroup">
              			<div class="col-4 pl-1 pr-0 new-entry-modal-btn"></div>
              			<div class="col-4 px-1 save-session-btn"></div>
              			<div class="col-4 pr-1 pl-0 openall-btn"></div>
              		</div>				  
				</div>
			</div>
              <ul class="list-group list-group-flush mt-1 board_data entry-list" id="${item.id}">
              </ul>
           </div>
        </div>`).find('.form-container').append(this.form).end();

		let entryCount = entry.count(item.id);
		this.tpl.find('.entry-count').html(`${entryCount}&nbsp;Entry`);
		if (entryCount > 1) {
			this.tpl.find('.entry-count').html(`${entryCount}&nbsp;Entries`);
		}

		this.tpl.find('.new-entry-modal-btn').append(this.newBtn);
		this.tpl.find('.save-session-btn').append(this.completeBtn);
		this.tpl.find('.openall-btn').append(this.clearAll);
		this.entry = this.tpl.find('.entry-list');
		this.boardAction = this.tpl.find('.board-action');
		this.boardAction.append(this.share);
		this.boardAction.append(this.delete);
		this.boardAction.append(this.createTaskBtn);

		_.renderEntries();
		return this.tpl;
	}

	this.renderEntries = function() {
		var _ = this;
		_.entry.html('');
		entry.getByColumn(_.item.id).forEach(eitem => {
			_.entry.append((new EntryController(eitem)).render());
		});
	}

	this.newEntry = function(obj){
		this.entry.append((new EntryController(obj)).render());
		this.reloadEntryCount();
	}

	this.reloadEntryCount = function() {

		let entryCount = entry.count(this.item.id);
		this.tpl.find('.entry-count').html(`${entryCount}&nbsp;Entry`);
		if (entryCount > 1) {
			this.tpl.find('.entry-count').html(`${entryCount}&nbsp;Entries`);
		}

		return this;
	}
};

let boardTemplate = {

	render: function (item, index) {

		item.column = item.column || [];

		let favorite_board = (item.is_favorite === 1) ? 'checked="checked"' : '';
		let favorite_title = (item.is_favorite === 1) ? 'Remove from favorites' : 'Make favorite';
		let count_title = ( entry.getByBoard(item.id).length > 1) ? 'Entries' : 'Entry';

		return `<div class="col-md-4 col-lg-3 col-sm-6 px-2 rendered-board-block dragable-element" id="board_block_${index}" data-item="${item.id}">
		<a href="board-detail.html" class="newfulllink board-select-btn dragable-element" data-item="${item.id}"></a>
      <div class="white_box">
        <div class="media">
          <div class="media-body mbody100">
          <h4 class="text-uppercase mb-1 text-truncate" id="board_name_${index}">
          		<a href="board-detail.html" class="board-select-btn" data-item="${item.id}">
          			${item.name || 'Unnamed board'}
          		</a>
          </h4>
          <div class="hide" id="board_form_${index}" >
          	<input type="text" id="edit_board_name_${index}" name="edit_board_name_${index}" value="${item.name}" class="board-name-to-edit" data-item="${index}" autocomplete="edit_board_name_${index}">
          </div>
          <span class="text-grey mb-3">${entry.getByBoard(item.id).length}&nbsp;${count_title}</span><div class="clearfix"></div><br>
          <span class="text-grey">` + (item.created_at).toDate() + `</span>
        </div>
          <div class="media-right">
        	<div class="fancyradio" data-item="${index}" title="` + favorite_title + `" >
        		<input type="radio" value="${item.id}" name="make_favorite" data-item="${index}" ` + favorite_board + ` autocomplete="make_favorite">
        		<span></span>
        	</div>
        </div>
        <div class="media-right d-flex flex-column personalBoard_section align-content-center flex-wrap">
        	<div class="text-right controls saperatelink">
        	
          	<a href="#" class="board-edit-btn" data-item="${index}"><img src="asset/image/pencil_icon.png"></a>
          	<a href="#" class="board-delete-btn" data-item="${index}" data-itemid="${item.id}">
          		<img src="asset/image/delete_icon.png">
          	</a>
          	<a href="#" class="board-share-btn" data-boardid="${item.id}">
          		<img src="asset/image/share_icon.png">
          	</a>
          	</div>
        </div>
      </div>
    </div>
  </div>`;

	},
	registerEvent: function () {

		$('.rendered-board-block').on('click', '.board-delete-btn', function () {

			let id = $(this).attr('data-itemid');
			let undoHtml = $(`<div class="alert alert-success custom-alert" id="alert_${id}">
	          Remove Complete. &nbsp;&nbsp; <strong class="pointer" data-undo="${id}" data-undotype="board">UNDO</strong>	          
	        </div>`);

	        message.prepend(undoHtml);
			setTimeout(function(){
				undoHtml.remove();
			}, 10000);
	        
			restorableRecord['board_' + id] = board.first(id);
			restorableRecord['board_entry_' + id] = entry.getByBoard(id);

			board.remove($(this).attr('data-item'));
			board.render();
		});

		$('.rendered-board-block').on('click', '.board-edit-btn', function () {
			boardTemplate.editForm($(this).attr('data-item'));
			$('#board_block_' + $(this).attr('data-item')).find('.newfulllink').hide();
		});
		$('.rendered-board-block').on('blur', '.board-name-to-edit', function () {
			board.udpate($(this).attr('data-item'), {
				"name": this.value
			});
			board.render();
			$('#board_block_' + $(this).attr('data-item')).find('.newfulllink').show();
		});
		$('.rendered-board-block').on('click', '.board-share-btn', function () {
			open_sharable_modal($(this).attr('data-boardid'));
		});

		$('.rendered-board-block').on('keyup', '.board-name-to-edit', function (evt) {
			if (evt.keyCode == 13) {
				$(this).blur();
			}
		});

		$('.rendered-board-block').on('click', '.board-select-btn', function () {
			RSStorage.setCurrentBoardId($(this).attr('data-item'));
		});

		$('[name="make_favorite"]').click(function () {
			board.removeFavorite();
			if(localStorage.getItem("sync_board") == 'true') {
				board.udpate($(this).attr('data-item'), {
					is_favorite: 1
				});
			} else {
				localStorage.setItem("board_for_new_tab", this.value);
			}
			RSStorage.setCurrentBoardId(this.value);
		});

	},
	editForm: function (index) {
		$('#board_name_' + index).hide();
		$('#board_form_' + index).show();
		$('#edit_board_name_' + index).focus();
	},
	makeSortable: function () {
		setTimeout(function () {

			$('#board_container').sortable({
				handle: ".dragable-element",
				placeholder: "ui-state-highlight col-sm-3 white_box",
				start: function (event, ui) {
					ui.item.addClass('tilt');
					tilt_direction(ui.item);
				},
				stop: function (e, ui) {
					board.getAll();
					ui.item.removeClass("tilt");


					$.map($(this).find('.rendered-board-block'), function (el) {

						board.updateById($(el).attr('data-item'), {
							sortable: $(el).index()
						}, 'not_sync');

					});

					setTimeout(function () {
						sync2();
					}, 100);

				}
			});

		}, 500);
	}

};


if ($('.board-page').length > 0) {
  
	$('#create_board_btn').click(function (evt) {
		$('#create_board_form').show();
		$(this).hide();
		$('#board_name').focus();
	});

	$('#create_board_submit').click(function (evt) {
		evt.preventDefault();
		var boardObj = board.create({ name: $('#board_name').val() });
		board.render();
		$('#create_board_btn').show();
		$('#create_board_form').hide();
		document.getElementById('board_form').reset();
	});
}
$(function () {
	$(document).ready(function () {
		board.render();

		if ($("#column_container").length > 0) {
			$("#column_container").mousedown(function (evt) {

				if (['input', 'textarea'].indexOf(evt.target.tagName.toLowerCase()) > -1) {
					return;
				}
				$("input:focus").blur();
			});
		}
	});

	$(document).on('click', '[data-undo]', function(){

		switch($(this).attr('data-undotype')){
			case 'board':
				board.restore($(this).attr('data-undo'));
			break;
			case 'column':
				board.restoreColumn($(this).attr('data-undo'), $(this).attr('data-boardid'));
			break;
			case 'multiple_entry':
				entry.restoreByColumn($(this).attr('data-undo'), $(this).attr('data-timestamp'));
				currentBoard.columns.instance[$(this).attr('data-undo')].reloadEntryCount().renderEntries();
			break;
			case 'entry':
				entry.restoreSelf($(this).attr('data-undo'));
			break;
			case 'new_entry':

				if(restorableRecord['new_entry_' + $(this).attr('data-undo')]) {
					restorableRecord['new_entry_' + $(this).attr('data-undo')].forEach(item => {						
						entry.deleteEntry(item.id);
					});


				}
			break;
		}
		
		$('#alert_' + $(this).attr('data-undo')).remove();
		
	});


});


if ($('.board-detail-page').length > 0) {

	currentBoard.id = RSStorage.getCurrentBoardId();
	currentBoard.init();

	document.getElementById('create_column_btn').onclick = function (evt) {
		if (currentBoard.id == undefined) {
			alert('You need to create a board before creating the column.');
			return;
		}
		currentBoard.createColumn({ type: 'link'});
	};

	  
	document.getElementById('create_new_entry_btn').onsubmit = function (evt) {

		evt.preventDefault();
		let flag = true;
		let entry_title = document.getElementById('entry_title');
		let entry_website_url = document.getElementById('entry_website_url');

		$('#er_entry_title').html('');
		$('#er_entry_website_url').html('');

		if (!entry_title.value) {
			$('#er_entry_title').html('This field is required');
			flag = false;
		}

		if (!entry_website_url.value) {
			$('#er_entry_website_url').html('This field is required');
			flag = false;
		} else {
			if (((entry_website_url.value).toLowerCase()).indexOf('http://') === -1 &&
				((entry_website_url.value).toLowerCase()).indexOf('https://') === -1
			) {
				entry_website_url.value = 'http://' + entry_website_url.value;
			}

			if (!isUrlValid(entry_website_url.value)) {
				$('#er_entry_website_url').html('Please enter valid url');
				flag = false;
			}
		}

		if (flag) {

			var lastIndex = entry.lastSortable(currentBoard.activeColumn);

			var obj = currentBoard.createEntry({
				title: entry_title.value,
				url: entry_website_url.value,
				sortable: lastIndex + 2,
				favIconUrl: 'https://www.google.com/s2/favicons?domain='+ entry_website_url.value
			});
			$('#createNew').modal('hide');
			if(obj === false) {
				alert("The url you are trying to save is already added in the system.");
			}
		}

	};

	function getFevicon(url, callback) {
		$.ajax({
			url: url,
			success: function (data) {
				callback(data);
			}
		});
	};


	$('#selected_board_name').keyup(function(e){
		if(e.keyCode == 13) {
			$('#selected_board_name').blur();
		}
	});

	$('#selected_board_name').focusout(function(e){
		boardController.update(currentBoard.id, {
			name: this.value
		});
	});

	$('#make_favorite').click(function(e){
		if(!this.checked) {
			this.checked = true;
			return;
		}
		mark_as_favorite(currentBoard.id);
	});

}

function mark_as_favorite(board_id) {
	board.removeFavorite();
	alert(board_id);
	if(localStorage.getItem("sync_board") == 'true') {
		board.updateById(board_id, {
			is_favorite: 1
		});
	} else {
		localStorage.setItem("board_for_new_tab", board_id);
	}
	RSStorage.setCurrentBoardId(board_id);
}


$(document).ready(function () {

	if ($('.popup-window').length < 1) {

		
		$('body').append(`<div class="modal fade" id="board_list" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
	        <div class="modal-dialog" role="document">
	          <div class="modal-content">
	             <div class="modal-body">
	              	<div class="popuphdr pb-0">
	                   <h5 class="modal-title text-white text-center mb-0">
	                      <span class="h5"> Choose the board</span>
	                      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><img src="asset/image/cross_icon.png" height="10"></button>
	                   </h5>
	                </div>
	                <ul class="list-group mt-2" id="board_list_container">
					</ul>
	              	
	              	<hr>
	                <div class="clearfix"></div>
	                <div class="row mt-3 px-2">
	                   <div class="col-6 px-2 m-auto"><a href="#" class="btn btn-primary btn-block" data-dismiss="modal">Cancel</a></div>
	                </div>

	             </div>
	          </div>
	        </div>
	    </div>`);

	    $('#board_list').on('shown.bs.modal', function() {
	    	
	    	$('#board_list_container').html('');
	    	board.get().map(item => {
	    		if(currentBoard.id == item.id && currentBoard.action == 'move') {
	    			return;
	    		}

	    		$('#board_list_container').append(`<li class="list-group-item link-hover text mb-2" move-column-to="${item.id}" >${item.name.ucfirst()}</li>`);
	    	});

	    }).on('hidden.bs.modal', function() {
	    	$('#board_list_container').html('');
	    });

	    $(document).on('click', '[move-column-to]', function() {
	    	
	    	if(currentBoard.action == 'move') {
		    	board.moveColumn($(this).attr('move-column-to'), currentBoard.activeColumn);
		    	service.moveColumn($(this).attr('move-column-to'), currentBoard.activeColumn);
		    	currentBoard.init();
		    } if(currentBoard.action == 'copy') {
		    	board.copyColumn($(this).attr('move-column-to'), currentBoard.activeColumn, function(res){
		    		// service.createOrUpdateColumn(res.obj.id);
		    		service.createOrUpdateMultipleEntry(res.entries);
		    	});
		    }
	    	$('#board_list').modal('hide');

	    });

	    $('body').append(`<div class="modal fade" id="seo_detail_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
	        <div class="modal-dialog" role="document">
	          <div class="modal-content">
	             <div class="modal-body">
	              	<div class="popuphdr pb-0">
	                   <h5 class="modal-title text-white text-center mb-0">
	                      <span class="h5">Meta detail</span>
	                      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><img src="asset/image/cross_icon.png" height="10"></button>
	                   </h5>
	                </div>
	                <form method="post" id="seo_form" class="mt-5">
	                <div class="col-sm-12">
			          	<div class="form-group">
			          		<label class="text">Meta Title</label>
			          		<input class="form-control" placeholder="Meta Title" type="text" name="meta_title" id="seo_title" maxlength="70" autocomplete="meta_title">
			          		<span class="text-danger"><small id="err_seo_title"></small></span>
			          	</div>
			        </div>

			        <div class="col-sm-12">
			          	<div class="form-group">
			          		<label class="text">Meta Description</label>
			          		<textarea class="form-control" placeholder="Meta Description" id="seo_description"  autocomplete="seo_description"></textarea>
			          		<span class="text-danger"><small id="err_seo_description"></small></span>
			          	</div>
			        </div>
			        <div class="col-sm-12">
			        	<label class="text">URL</label>
			          	<div class="input-group mb-3">
						    <div class="input-group-prepend">
					      		<span class="input-group-text">https://qlearly.com/x/b</span>
					    	</div>
					    	<input type="text" class="form-control" placeholder="Link Url" id="sharable_code" autocomplete="sharable_code">
					  		<span class="text-danger"><small id="err_seo_sharable_code"></small></span>
					  	</div>
			        </div>
			        <div class="col-sm-12">
			          	<div class="form-group">
			          		<label class="text">Made by</label>
			          		<input class="form-control" placeholder="Made by" type="text" name="meta_title" id="seo_author" maxlength="70" autocomplete="meta_title">
			          		<span class="text-danger"><small id="err_seo_author"></small></span>
			          	</div>
			        </div>			        
			        <div class="col-sm-12">
			        	<label class="text">Made By URL</label>
			          	<div class="form-group">
					    	<input type="text" class="form-control" placeholder="Made By URL" id="seo_made_by_url" autocomplete="seo_made_by_url">
					  		<span class="text-danger"><small id="err_seo_made_by_url"></small></span>
					  	</div>
			        </div>

			        <div class="col-sm-12">
			          	<div class="form-group">
			          		<label class="text">Thumbnail</label>
			          		<div class="imgCircle" id="seo_image_container">
							    <input type="file" class="form-control-file border" id="seo_image" name="image"  autocomplete="image">
							    <img id="seo_image_preview" alt="no image">
							</div>

			          		<span class="text-danger"><small id="err_seo_image"></small></span>
			          	</div>
			        </div>

	              	<hr>
	                <div class="clearfix"></div>

			        <div class="col-sm-12 mt-4 d-none" id="seo_success_msg_container">
				        <div class="alert alert-success" id="seo_success_msg">
						  <strong>Success!</strong> Page has been updated successful.
						</div>
					</div>

	                <div class="col-sm-12">
		                <div class="row mt-3 px-2">
		                   <div class="col-6 px-2">
		                   		<a href="#" class="btn btn-primary btn-block" data-dismiss="modal">Cancel</a>
		                   </div>
		                   <div class="col-6 px-2">
		                   		<button class="btn btn-primary btn-block" type="submit" id="seo_save">Save</button>
		                   </div>
		                </div>
		            </div>
	                </form>
	             </div>
	          </div>
	        </div>
	    </div>`);

	    $('#seo_detail_modal').on('hidden.bs.modal', function() {
	    	$('#seo_success_msg_container').addClass('d-none');
	    	$('#seo_image').val('')
	    });

	    $('#seo_image').change(function() {
	    	if($('#seo_image')[0].files[0]) {

	    		if(['jpg', 'jpeg', 'png', 'gif'].indexOf($('#seo_image')[0].files[0].type.split('/')[1]) === -1) {
	    			$('#seo_image').val('')
					$('#err_seo_image').html('Only jpg, jpeg, png and gif image is allowed');
					return;
	    		}
	    		var reader = new FileReader();
	    		$('#seo_image_container').removeClass('blank');

	    		reader.onload = function(e) {
	    			$('#seo_image_preview').attr('src', e.target.result);
			    }

	    		reader.readAsDataURL($('#seo_image')[0].files[0]);
		    	
	    	}
	    });

	    $('#seo_form').submit(function(evt) {

	    	evt.preventDefault();
	    	var flag = true;
	    	$('#seo_success_msg_container').addClass('d-none');

	    	$('[id*="err_seo_"]').html('');
	    	if($('#seo_title').val().trim() == '') {
	    		$('#err_seo_title').html('This field is required');
	    		flag = false;
	    	}

	    	if($('#seo_description').val().trim() == '') {
	    		$('#err_seo_description').html('This field is required');
	    		flag = false;
	    	}

	    	if(!isUrlValid($('#seo_made_by_url').val().trim())) {
	    		$('#err_seo_made_by_url').html('Please enter valid url');
	    		flag = false;	
	    	}

	    	if($('#sharable_code').val().trim() == '') {
	    		$('#err_seo_sharable_code').html('This field is required');
	    		flag = false;
	    	} else if(!isValidShotCode($('#sharable_code').val().trim())) {
	    		$('#err_seo_sharable_code').html('Link url can only contents alphabets, numbers, underscore or dash.');
	    		flag = false;
	    	}


	    	if(flag == true) {
	    		
	    		var fd = new FormData();
	    		var boardDetail = board.first(currentBoard.id);
				
				var url = $('#seo_made_by_url').val().trim();
				if(url) {
					url = url.makeValidUrl();
				}


	    		fd.append('created_at', boardDetail.created_at); 
	    		fd.append('author', $('#seo_author').val().trim()); 
	    		fd.append('meta_title', $('#seo_title').val().trim()); 
	    		fd.append('meta_description', $('#seo_description').val().trim()); 
	    		fd.append('image', $('#seo_image')[0].files[0]);
	    		fd.append('author_url', url );

	    		
	    		var oldHtml = $('#seo_save').html();
	    		$('#seo_save').html('Saving...');
	    		
	    		if(currentBoard.action == 'column') {
	    			service.post(service.version + "column/sharable-url", {
		    			id: selectedColumn.id,
		    			sharable_code: $('#sharable_code').val().trim()
		    		}).then(function(response){

		    			fd.append('id', selectedColumn.id); 
		    			fd.append('name', selectedColumn.name); 
			    		fd.append('sortable', selectedColumn.sortable); 

		    			$.ajax({
							url: service.endpoint + service.version + "column",
							method: 'POST',
							data: fd,
							headers: {
								'authorization': "Bearer " + auth.getToken()
							},
							contentType:false,
		                    cache: false,
		                    processData:false,
							success: function (result) {
								$('#seo_save').html(oldHtml);
			    				$('#seo_success_msg_container').removeClass('d-none');
			    				$('#seo_image').val('')

			    				board.updateColumn(selectedColumn.id, {
			    					author_url: url,
			    					author: $('#seo_author').val().trim(),
			    					meta_title: $('#seo_title').val().trim(),
					    			meta_description: $('#seo_description').val().trim(),
					    			sharable_code: $('#sharable_code').val().trim(),
					    			image: result.data.image
					    		}, 'not_sync');
							},
							error: function (response) {
								$('#seo_save').html(oldHtml);
			    				$('#seo_success_msg_container').removeClass('d-none');
			    				$('#seo_image').val('')
							}
						});

		    		});
	    			return;
	    		}
	    		service.post(service.version + "board/sharable-url", {
	    			id: currentBoard.id,
	    			sharable_code: $('#sharable_code').val().trim()
	    		}).then(function(response){

	    			if(response.success == true) {

			    		board.updateById(currentBoard.id, {
			    			author_url: url,
	    					author: $('#seo_author').val().trim(),
			    			meta_title: $('#seo_title').val().trim(),
			    			meta_description: $('#seo_description').val().trim(),
			    			sharable_code: $('#sharable_code').val().trim()
			    		}, 'not_sync');

			    		fd.append('id', currentBoard.id); 
			    		fd.append('name', boardDetail.name); 
			    		fd.append('is_favorite', boardDetail.is_favorite); 
			    		fd.append('sortable', boardDetail.sortable); 

						$.ajax({
							url: service.endpoint + service.version + "board",
							method: 'POST',
							data: fd,
							headers: {
								'authorization': "Bearer " + auth.getToken()
							},
							contentType:false,
		                    cache: false,
		                    processData:false,
							success: function (result) {
								$('#seo_save').html(oldHtml);
			    				$('#seo_success_msg_container').removeClass('d-none');
			    				$('#seo_image').val('')

			    				board.updateById(currentBoard.id, {
			    					author_url: url,
			    					author: $('#seo_author').val().trim(),
			    					meta_title: $('#seo_title').val().trim(),
					    			meta_description: $('#seo_description').val().trim(),
					    			sharable_code: $('#sharable_code').val().trim(),
					    			image: result.data.image
					    		}, 'not_sync');
							},
							error: function (response) {
								$('#seo_save').html(oldHtml);
			    				$('#seo_success_msg_container').removeClass('d-none');
			    				$('#seo_image').val('')
							}
						});

						return;

			    		 

			    		// service.createOrUpdateBoard(currentBoard.id, function(response){
			    		// 	$('#seo_save').html(oldHtml);
			    		// 	$('#seo_success_msg_container').removeClass('d-none');
			    		// });

			    	} else {
			    		$('#err_seo_sharable_code').html(response.msg);
			    		$('#seo_save').html(oldHtml);
			    	}

		    	});
	    	}

	    });


		$('body').append(`<div class="modal fade" id="share_column" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
             <div class="modal-body">
                <div class="popuphdr">
                   <h5 class="modal-title text-white text-center">
                      <span id="selected_collection" class="h5"></span>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><img src="asset/image/cross_icon.png" height="10"></button>
                   </h5>
                   <form class="mt-3 px-2">
                      <div class="clearfix">
                         <div class="search_holder whiteinput">
                            <input class="full_search_bx" placeholder="Invite someone by email" id="search_from_sharable_popup" autocomplete="search_from_sharable_popup">
                            <span class="under_line"></span>
                            <span class="text-danger"><small id="er_password"></small></span>
                         </div>
                      </div>
                   </form>
                </div>
                <div class="col-sm-12" id="spop_no_users_filtered" style="display: none;">
                  <hr>
                  <div class="m-auto">
                    <br />
                    <br />
                    <br />
                    <h5 class="text-center">
                      No person or team found in your organization
                    </h5>
                    <br />
                    <p class="text-center">
                      Type a valid email to invite new member
                    </p>
                    <br />
                    <br />
                  </div>
                </div>
                <div class="clearfix"></div>
                <div class="col-sm-12" id="spop_share_user_btn_block" style="display: none;">
                  <hr>
                  <div class="m-auto">
                    <button class="btn theme_btn btn-white float-right btn-lg btn-block justify-content-end mb-3" 
                       type="button" id="spop_invide_people">
                    Invite Teammate
                    </button>
                  </div>
                </div>
                <div class="clearfix"></div>
                <div class="col-sm-12" id="spop_users_list">
                   <hr>
				   <label class="text-primary" id="spop_selected_user_count">Person(1)</label>
				   <ul class="list-group row">
				   <li class="list-group-item py-2">
						<div class="media">
							<div class="media-left pr-2 text-primary">
								<img src="asset/image/tick.svg" height="14">
							</div>
							<div class="media-body">${authController.data.name}</div>
							<div class="media-right">
								<small class="colorGry">${authController.data.email}</small>
							</div>
						</div>
					</li>
                   </ul>
                   <ul class="list-group row" style="height: 180px; overflow: auto;" id="sharable_user_list">
                   </ul>
                   <hr>
                   <p class="text-center mt-3">
                      <a href="#" class="colorGry" id="show_all_teammates">
                      	Show all teammates in board name</a>
                   </p>
                </div>
                <div class="row">
                   <div class="col-sm-12">
                      <div class="card " style="background: #f5f5f5">
                         <div class="card-body">
                            <div class="media">
                               <div class="media-left align-self-center pr-2">
                                  <img src="asset/image/broken-link.svg" height="17px;" class="greenLink">

                               </div>
                               <div class="media-body align-self-center">
                                  <h6 class="card-title colorGry mb-0 column_sharable_url">
                                    Share this board via link
                                  </h6>
                               </div>
                               <div class="media-right align-self-center">
                                  <a href="#" class="btn btn-primary create-sharable-link">Create Link</a>
                                  <a href="#" class="btn btn-primary remove-sharable-link">Remove Link</a>
                                  <a href="#" class="btn btn-primary edit-sharable-link" data-toggle="modal" data-target="#seo_detail_modal" data-dismiss="modal" >Edit</a>
                               </div>
                            </div>
                         </div>
                      </div>
                   </div>
                </div>
                <hr>
                <div class="clearfix"></div>
                <div class="row mt-3 px-2">
                   <div class="col-6 px-2"><a href="#" class="btn btn-primary btn-block" data-dismiss="modal">Cancel</a></div>
                   <div class="col-6 px-2"><a href="#" class="btn btn-primary btn-block share-column-ok-btn"  data-dismiss="modal">Ok</a></div>
                </div>
             </div>
          </div>
        </div>
    </div>`);

		$('body').append(`<div class="modal fade" id="share_column_2" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
             <div class="modal-body">
                <div class="popuphdr">
                   <h5 class="modal-title text-white text-center">
                      <span class="h5 selected_collection"></span>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><img src="asset/image/cross_icon.png" height="10"></button>
                   </h5>
                </div>
                <div class="clearfix"></div>
                 
                <br /><br />
                <div class="row">
                   <div class="col-sm-12">
                      <div class="card " style="background: #f5f5f5">
                         <div class="card-body">
                            <div class="media">
                               <div class="media-left align-self-center pr-2">
                                  <img src="asset/image/broken-link.svg" height="17px;" class="greenLink">

                               </div>
                               <div class="media-body align-self-center">
                                  <h6 class="card-title colorGry mb-0 column_sharable_url">
                                    Share this column via link
                                  </h6>
                               </div>
                               <div class="media-right align-self-center">
                                  <a href="#" class="btn btn-primary edit-sharable-link" data-toggle="modal" data-target="#seo_detail_modal" data-dismiss="modal" >Edit</a>
                               </div>
                                
                            </div>
                         </div>
                      </div>
                   </div>
                </div>
                <br />
                <hr>
                <div class="clearfix"></div>
                <div class="row mt-3 px-2">
                   <div class="col-6 px-2"><button class="btn btn-primary btn-block" data-dismiss="modal">
                   		Cancel</button></div>
                   <div class="col-6 px-2">
                   	<button href="#" class="btn btn-primary btn-block create-sharable-link mt-0">
                   		Create Link</button>
                   	<button href="#" class="btn btn-primary btn-block remove-sharable-link hide mt-0">
                   		Remove Link
                   	</button>
                   </div>
                </div>
             </div>
          </div>
        </div>
    </div>`);

$('body').append(`<div class="modal fade" id="change_password_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	       <div class="modal-body">
	          <h5 class=" text-center mt-3 mb-4 text-muted mb-4">Change Password</h5>
	          <div class="col-sm-12">
	          	<div class="form-group">
	          		<input class="form-control" placeholder="Current Password" type="password" id="cpwd_current_password" autocomplete="cpwd_current_password">
	          		<span class="text-danger"><small id="err_cpwd_current_password"></small></span>
	          	</div>
	          </div>
	          <div class="col-sm-12">
	          	<div class="form-group">
	          		<input class="form-control" placeholder="Password" type="password" id="cpwd_password" autocomplete="cpwd_password">
	          		<span class="text-danger"><small id="err_cpwd_password"></small></span>
	          	</div>
	          </div>
	          <div class="col-sm-12">
	          	<div class="form-group">
	          		<input class="form-control" placeholder="Change Password" type="password" id="cpwd_confirm_password" autocomplete="cpwd_confirm_password">
	          		<span class="text-danger"><small id="err_cpwd_confirm_password"></small></span>
	          	</div>
	          </div>
	        <div class="col-sm-12 mt-4 d-none" id="cpwd_success_msg">
		        <div class="alert alert-success">
				  <strong>Success!</strong> Password has been changed successful.
				</div>
			</div>
          	<div class="col-sm-12 mt-4">
          		<button class="btn btn-primary kbd p-2 btn-block px-4" id="change_pwd_btn">Submit</button>
      		</div> 
	    </div>
	    </div>
	  </div>
	</div>`);

$('#change_pwd_btn').click(function(){

	var flag = true;

	$('[id*="err_cpwd_"]').html('');
	if($('#cpwd_current_password').val() == '') {
		$('#err_cpwd_current_password').html('This field is required');
		flag = false;
	}

	if($('#cpwd_password').val() == '') {
		$('#err_cpwd_password').html('This field is required');
		flag = false;
	}

	if($('#cpwd_confirm_password').val() == '') {
		$('#err_cpwd_confirm_password').html('This field is required');
		flag = false;
	}

	if($('#cpwd_confirm_password').val() != $('#cpwd_password').val()) {
		$('#err_cpwd_confirm_password').html('Password and confirm password should be same.');
		flag = false;
	}

	if(flag) {
		let oldValue = $('#change_pwd_btn').html();
		$('#change_pwd_btn').html('<div class="small-loader"></div>');
		let para = {
			current_password: $('#cpwd_current_password').val(),
			new_password: $('#cpwd_password').val(),
			confirm_password: $('#cpwd_confirm_password').val()
		};

		service.post('admin/post-change-password', para).then(function(response) {
			$('#change_pwd_btn').html(oldValue);
			if(response.success) {
				$('#cpwd_success_msg').removeClass('d-none');
				$('[id*="cpwd_"]').val(''); 
			} else {
				alert(response.message);
			}
		})
		.catch(function(response){
			$('#change_pwd_btn').html(oldValue);
		});
	}

});

$('#change_password_modal').on('hidden.bs.modal', function () {
	$('#cpwd_success_msg').addClass('d-none');
	$('[id*="cpwd_"]').val(''); 
});


$('body').append(`<div class="modal fade" id="profile_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	       <div class="modal-body">
	          <h5 class=" text-center mt-3 mb-4 text-muted mb-4">Account preferences</h5>
	          <h5 class="text-center mb-3 text" id="top_user_name"></h5>
	          	<div class="row px-3 mb-3">
	          		<div class="col-sm-12 text-center">
		          		<button data-dismiss="modal" data-toggle="modal" data-target="#change_password_modal" class="btn btn-dark kbd p-1 px-4">Change Password</button>		      		
		          		<button data-dismiss="modal" class="btn btn-dark kbd p-1  px-4 logout-btn">Logout</button>
		      		</div>
	      		</div>
	          <small class="text-muted d-none text-center mb-3">Expect changes within 7 days after submitting the request</small>
	          <div class="col-sm-12">
	          	<div class="form-group">
	          		<input class="form-control" placeholder="Name" type="text" id="ep_name" autocomplete="ep_name">
	          		<span class="text-danger"><small id="err_ep_name"></small></span>
	          	</div>
	          </div>
	          <div class="col-sm-12">
	          	<div class="form-group">
	          		<input class="form-control" placeholder="Username" type="text" id="ep_username" autocomplete="ep_username">
	          		<span class="text-danger"><small id="err_ep_username"></small></span>
	          	</div>
	          </div>
	          <div class="col-sm-12">
	          	<div class="form-group">
	          		<input class="form-control" placeholder="Email" type="email" id="ep_email" autocomplete="email">
	          		<span class="text-danger"><small id="err_ep_email"></small></span>
	          	</div>
	          </div>
	        <div class="col-sm-12 text">
	          	<label><input type="checkbox" id="ep_newsletter" value="1" name="ep_newsletter" autocomplete="ep_newsletter"> Receive updates and more. We will never spam you, don't worry!</label>
	        </div>
	        <div class="col-sm-12 mt-4 hide" id="ep_success_msg">
		        <div class="alert alert-success">
				  <strong>Success!</strong> Profile has been updated successful.
				</div>
			</div>
          	<div class="col-sm-12 mt-4">
          		<button class="btn btn-primary kbd p-2 btn-block px-4" id="edit_profile">Submit</button>
      		</div> 
	    </div>
	    </div>
	  </div>
	</div>`);

	$('#profile_modal').on('shown.bs.modal', function () {
		$('#ep_success_msg').hide();
		var user = auth.user();
		$('#top_user_name').html((user.name)? (user.name.ucfirst()) : user.username);
		$('#ep_email').val(user.email);
		$('#ep_name').val(user.name);
		$('#ep_username').val(user.username);
		$('#ep_newsletter').removeAttr('checked');
		if(user.newsletter == 1) {
			$('#ep_newsletter').attr('checked', 'checked');
		}
		

	});

	$('#edit_profile').click(function() {

		$('[id*="err_ep_"]').html('');
		$('#ep_success_msg').hide();
		var user = auth.user();
		var para = {
			email: $('#ep_email').val(),
			name: $('#ep_name').val(),
			username: $('#ep_username').val(),
			newsletter: $('#ep_newsletter:checked').val() || 0,
		};

		let oldValue = $('#edit_profile').html();
		$('#edit_profile').html('<div class="small-loader"></div>');	

		service.post( service.version + 'profile', para).then(function(response) {
			if(response.success) {
				user.name = response.result.name;
				user.email = response.result.email;
				user.username = response.result.username;
				user.newsletter = response.result.newsletter;
				RSStorage.setUser(user);
				$('#ep_success_msg').show();
				setTimeout( function(){
					$('#ep_success_msg').fadeOut();
				}, 3000);
			}
			$('#edit_profile').html(oldValue);
		})
		.catch(item => {
			$('#edit_profile').html(oldValue);
			item = JSON.parse(item) || {};
			if(item.hasOwnProperty('email')) {
				$('#err_ep_email').html(item.email[0]);
			}
			if(item.hasOwnProperty('username')) {
				$('#err_ep_username').html(item.username[0]);
			}
			if(item.hasOwnProperty('name')) {
				$('#err_ep_name').html(item.username[0]);
			}
		});
	});

	$('body').append('<div class="modal fade" id="short_cut_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">'+
	  '<div class="modal-dialog" role="document">'+
	  '<div class="modal-content">'+
	       '<div class="modal-body">'+
	          '<h5 class=" text-center mt-3 mb-4 text-muted mb-4">Keyboard Shortcuts</h5>'+
	          '<table class="col-12 m-auto">'+
	           	'<tr>'+
	              '<td class="p-3 text-left text-muted">Search</td>'+
	              '<td class="p-3 text-right">'+
	              		'<kbd>/</kbd> <span class="text-muted">or</span> <kbd>Shift + /</kbd>'+
	              '</td>'+
	            '</tr>'+
	            '<tr>'+
	              '<td class="p-3 text-left text-muted">New Board</td>'+
	              '<td class="p-3 text-right"><kbd>Shift + B</kbd></td>'+
	            '</tr>'+
	            '<tr>'+
	              '<td class="p-3 text-left text-muted">New Column</td>'+
	              '<td class="p-3 text-right"><kbd>Shift + N</kbd></td>'+
	            '</tr>'+
	            '<tr>'+
	              '<td class="p-3 text-left text-muted">Save Session</td>'+
	              '<td class="p-3 text-right"><kbd>Shift + S</kbd></td>'+
	            '</tr>'+
	            '<tr>'+
	              '<td class="p-3 text-left text-muted">Show Current Tabs</td>'+
	              '<td class="p-3 text-right"><kbd>Shift + C</kbd></td>'+
	            '</tr>'+
	            '<tr>'+
	              '<td class="p-3 text-left text-muted">New Task</td>'+
	              '<td class="p-3 text-right"><kbd>Shift + T</kbd></td>'+
	            '</tr>'+
	            '<tr>'+
	              '<td class="p-3 text-left text-muted">New Note</td>'+
	              '<td class="p-3 text-right"><kbd>Shift + D</kbd></td>'+
	            '</tr>'+
	            '<tr>'+
	              '<td class="p-3 text-left text-muted">All Available Shortcuts</td>'+
	              '<td class="p-3 text-right"><kbd>Shift + A</kbd></td>'+
	            '</tr>'+
	            '<tr>'+
	              '<td class="p-3 text-left text-muted">Open All Tabs</td>'+
	              '<td class="p-3 text-right"><kbd>Shift + Column # 1-9</kbd></td>'+
	            '</tr>'+
	          '</table>'+
	          '<div class="col-sm-12 mt-4">'+
	          '<button data-dismiss="modal" class="btn btn-primary kbd p-2 px-4">Got It!</button>'+
	      '</div>'+
	    '</div>'+
	    '</div>'+
	  '</div>'+
	'</div>');

		const share_column = $('#share_column');
		const share_column_2 = $('#share_column_2');

		// $('#share_column').find('.share-column-ok-btn').click(function () {
		// 	let column_id = '';
		// 	if (selectedColumn) {
		// 		column_id = selectedColumn.id;
		// 	}
		// 	$('#share_column').modal('hide');

		// 	users.updateBatch(selColumnUsers.map( item => {
		// 		return {
		// 			email: item.email,
		// 			name: "",
		// 			board_id: [ sharableBoard.id ],
		// 			sharable_id: [ sharableBoard.id ]
		// 		};					
		// 	}));

		// 	service.post(service.version + 'invite', {
		// 		board_id: sharableBoard.id,
		// 		column_id: column_id,
		// 		emails: selColumnUsers.map(a => a.email)
		// 	}).then(function (response) {

		// 		if(response.hasOwnProperty('response')) {
		// 			users.save(response.users);
		// 		}
		// 		// users.updateBatch(response.users);
		// 		$('#share_column').modal('hide');
		// 	}).catch(function (response) { });
		// });

	}


	$('#createNew').on('hidden.bs.modal', function () {
		$('#entry_title').val('');
		$('#er_entry_title').html('');
		$('#entry_website_url').val('');
		$('#er_entry_website_url').html('');
	});

	$('#createNew').on('shown.bs.modal', function () {
		$('#entry_title').focus();
	});

	$('#share_column_2').find('.create-sharable-link').click(function () {
		service.post2(service.version + 'sharecolumn/' + selectedColumn.id, {}, function (response) {
			if (response.success == false) {
				alert(response.msg);
				return;
			}
			changeSharableLink(response.data.code);
			board.updateColumn(selectedColumn.id, {
				sharable_code: response.data.code
			});

		});
	});

	$('#share_column').find('.create-sharable-link').click(function () {

		service.post2(service.version + 'shareboard/' + sharableBoard.id, {}, function (response) {
			if (response.success == false) {
				alert(response.msg);
				return;
			}
			changeSharableLink(response.data.code, 'b');
			board.updateById(sharableBoard.id, {
				sharable_code: response.data.code
			});

		});

	});


	$('#share_column_2').find('.remove-sharable-link').click(function () {
		service.delete(service.version + 'sharecolumn/' + selectedColumn.id, {}, function (response) {
			if (response.success == false) {
				alert(response.msg);
				return;
			}
			defualtSharableLink();
			board.updateColumn(selectedColumn.id, {
				sharable_code: ''
			});
		});
	});

	$('#share_column').find('.remove-sharable-link').click(function () {
		service.delete(service.version + 'shareboard/' + sharableBoard.id, {}, function (response) {
			if (response.success == false) {
				alert(response.msg);
				return;
			}
			defualtSharableLink();
			board.updateById(sharableBoard.id, {
				sharable_code: ''
			});
		});
	});

	let search_from_sharable_popup = document.getElementById('search_from_sharable_popup');
	if (search_from_sharable_popup) {
		search_from_sharable_popup.onkeydown = function (evt) {

			let value = this.value.toLowerCase();

			let result = selColumnUsers.filter(obj => {
				if ((obj.name.toLowerCase()).indexOf(value) > -1) {
					return true;
				}
				if ((obj.email.toLowerCase()).indexOf(value) > -1) {
					return true;
				}
				return false;
			});

			$('#spop_users_list').show();
			$('#spop_share_user_btn_block').hide();
			$('#spop_no_users_filtered').hide();

			if (result.length <= 0 && value != '' && isEmailValid(value)) {
				$('#spop_users_list').hide();
				$('#spop_share_user_btn_block').show();
			} else if (result.length <= 0 && value != '') {
				$('#spop_users_list').hide();
				$('#spop_no_users_filtered').show();
			}
			if (result.length > 0) {
				addUserToSharableList(result);
			}
		};

	};
	let spop_invide_people = document.getElementById('spop_invide_people');

	if (spop_invide_people) {
		spop_invide_people.onclick = function (evt) {
			
			var maxUser = authController.maxUser();
			// if( ( users.get().length + newInvitedUser.length ) >= maxUser) {
			if( users.get().length >= maxUser) {
				alert("You can't invite more than " + maxUser + " member, Please upgrade your plan to invite more user");
				return;
			}
			$('.big-centered-loader').show();
			let item = {
				name: search_from_sharable_popup.value,
				email: search_from_sharable_popup.value,
				status: 'invite'
			};
			newInvitedUser.push(item);
			selColumnUsers.push(item);

			// addUserToSharableList(selColumnUsers);

			$('#spop_users_list').show();
			$('#spop_share_user_btn_block').hide();
			search_from_sharable_popup.value = '';

			// invite user code
			let column_id = '';
			if (selectedColumn) {
				column_id = selectedColumn.id;
			}
			// users.updateBatch(selColumnUsers.map( item => {
			// 	return {
			// 		email: item.email,
			// 		name: "",
			// 		board_id: [ sharableBoard.id ],
			// 		sharable_id: [ sharableBoard.id ]
			// 	};					
			// }));

			service.post(service.version + 'invite', {
				board_id: sharableBoard.id,
				column_id: column_id,
				emails: selColumnUsers.map(a => a.email)
			}).then(function (response) {

				if(response.hasOwnProperty('users')) {
					users.save(response.users);

					selColumnUsers = response.users.filter(function (item) {
						return (item.board_ids.indexOf(sharableBoard.id) > -1);
					});
					
					addUserToSharableList(selColumnUsers);
				}
				
				$('.big-centered-loader').hide();
			}).catch(function (response) { 
				$('.big-centered-loader').hide();
			});
		};
	};

	if ($('#share_board_btn').length > 0) {

		document.getElementById('share_board_btn').onclick = function (evt) {
			currentBoard.action = 'board';
			open_sharable_modal(currentBoard.id);
		};
	}

	$(document).on('click', '.cancel-invitation', function(){
		let id = this.getAttribute('data-id');
		if(id) {	
			$('.big-centered-loader').show();
			service.post2(service.version + "cancel-invitation/" + id, {}, function (response) {
				$('#invitation-container-' + id).remove();
				if(response.hasOwnProperty('users')) {
					users.save(response.users);

					selColumnUsers = response.users.filter(function (item) {
						return (item.board_ids.indexOf(sharableBoard.id) > -1);
					});
				}
				$('.big-centered-loader').hide();				
			});
		}
	});

	if ($('#top_search').length > 0) {
		let isLinkAdded = false, isNoteAdded= false, isBoardAdded = false;
		searchString = '';
		$(function () {
			$("#top_search").autocomplete({
				autoFocus: true,			
				source: function (request, response) {
					isLinkAdded = false;
					isNoteAdded = false;
					isBoardAdded = false;
					var availableTags = [];
					if($('.board-page').length > 0 || localStorage.getItem("search_all_or_specific_board") !== "true") {

						entry.get().map(function (item) {							
							if(['link', 'note'].indexOf(item.type) !== -1) {
								item.label = item.title;
								item.value = item.title;	
								item.category = item.type;			
								availableTags.push(item);
							}
						});

						boardController.get().map(function (item) {
							item.label = item.name;
							item.value = item.name;	
							item.category = 'board';
							availableTags.push(item);
						});
					} else {

						entry.getByBoard(currentBoard.id).map(function (item) {
							
							if(['link', 'note'].indexOf(item.type) !== -1) {
								item.label = item.title;
								item.value = item.title;	
								item.category = item.type;			
								availableTags.push(item);
							}
						})

						boardController.get().map(function (item) {
							item.label = item.name;
							item.value = item.name;	
							item.category = 'board';
							availableTags.push(item);
						});
					}
					var results = $.ui.autocomplete.filter(availableTags, request.term);

					var results2 = {
						links: [],
						boards:[],
						notes: []						
					};

					results2.links = results.filter(item => {
						return item.category === 'link';
					});

					results2.boards = results.filter(item => {
						return item.category === 'board';
					});

					results2.notes = results.filter(item => {
						return item.category === 'note';
					});
 
					results2.links.push({
						title: request.term,
						favIconUrl: 'asset/image/google-logo.png',
						url: "https://www.google.com/search?q=" + request.term,
						label: 'NoMatchesFound',
						value: request.term,
						category: "NoMatchesFound"
					});

					results = results2.links.concat(results2.boards);
					results = results.concat(results2.notes);					
					response(results);
				},
				minLength: 0,
				select: function (event, ui) {
					
					if (ui.item != undefined) {
						if(['link', 'NoMatchesFound'].indexOf(ui.item.category) >= 0) {
							window.open(ui.item.url, urlTarget);
						} else if(ui.item.category === 'note') {

							entryDetail = ui.item;
							$('#note_title').val((ui.item.title || '').ucfirst());
							$('#note_body').val((ui.item.description || '').ucfirst());
							$('#edit_note_model').modal('show');
							entryObject = function(title, description){
								$('#edit_note_model').modal('hide');
							}
							
						} else if(ui.item.category === 'board') {
							if($('.board-page').length > 0) {
								RSStorage.setCurrentBoardId(ui.item.id);
								window.open(chrome.extension.getURL('board-detail.html'), '_self');
								document.location.assign = chrome.extension.getURL('board-detail.html')
							} else {
								RSStorage.setCurrentBoardId(ui.item.id);
								currentBoard.id = ui.item.id;
								currentBoard.init();
								$('#selected_board_name').val(ui.item.name.ucfirst());

								$('#make_favorite').removeAttr('checked');
								if(ui.item.is_favorite === 1) {
									$('#make_favorite').attr('checked', 'false')
								}
							}
						}

						$("#top_search").blur();
						setTimeout(() => {
							$("#top_search").val('');
						}, 1000);
						
					}
				},
				close: function () {
					this.value = ''
				},
			})
			.keydown( function (evt, ui) {
				if(evt.keyCode === 13) {
					evt.preventDefault();
				}
			})
			.focus(function (event, ui) {
				$(this).autocomplete("search");
			})

			.autocomplete("instance")._renderItem = function (ul, result) {
				
				var spanObj = $('<span class="ui-menu-item">');

				if(result.category === 'link') {
					if(isLinkAdded === false) {
						isLinkAdded = true;
						spanObj.append('<li class="dropdownHead"><span>Bookmarks</span></li>').appendTo(ul);
					}
				} else if(result.category === 'note') {
					if(isNoteAdded === false) {
						isNoteAdded = true;
						spanObj.append('<li class="dropdownHead"><span>Notes</span></li>').appendTo(ul);
					}
				} else if(result.category === 'board') {
					if(isBoardAdded === false) {
						isBoardAdded = true;
						spanObj.append('<li class="dropdownHead"><span>Boards</span></li>').appendTo(ul);
					}
				}

				var html = searchComponent(result);
				return spanObj.append(html).appendTo(ul);
			};
		});
	}

	$('#favicon').attr('href', chrome.extension.getURL('asset/image/icons/16.png'))

});

function signup() {
	if(!auth.isLoggedIn()) {
		$('.open-signup').trigger('click');
		return true;		
	}
	return false;
}

function searchComponent(eitem) {

	if(eitem.hasOwnProperty('category')) {

		if(eitem.category === 'link') {
			
			tsBlock = $(`<li class="pointer dropdown-item apps_typeahead plastic_typeahead ui-menu-item-wrapper">
					<a class="fullLi url-click" target="${urlTarget}" role="menuitem" tabindex="1">
					<div class="d-flex align-content-center">	     
						<div class="iconsleft pr-2 align-items-center d-flex">
							<img src="${eitem.favIconUrl}" height="15" on-error="asset/image/default_favicon.png">
						</div>   
						<div class="py-2">
							<p class=" entryTitle m-0 py-1 text-truncate">${eitem.title}</p>
						</div>
					</div></a>
				</li> 
			`);
		} else if(eitem.category === 'board') {

			tsBlock = $(`<li class="pointer dropdown-item apps_typeahead plastic_typeahead ui-menu-item-wrapper">
					<a class="fullLi url-click" target="${urlTarget}" role="menuitem" tabindex="1">
					<div class="d-flex align-content-center">	     
						<div class="iconsleft pr-2 align-items-center d-flex">
							<img src="asset/image/board_icon.png" height="15" on-error="asset/image/default_favicon.png" class="backToWhite">
						</div>   
						<div class="py-2">
							<p class=" entryTitle m-0 py-1 text-truncate">${eitem.name || 'Untitled'}</p>
						</div>
					</div></a>
				</li> 
			`);
		} else if(eitem.category === 'note') {

			tsBlock = $(`<li class="pointer dropdown-item apps_typeahead plastic_typeahead ui-menu-item-wrapper">
					<a class="fullLi url-click" target="${urlTarget}" role="menuitem" tabindex="1">
					<div class="d-flex align-content-center">	     
						<div class="iconsleft pr-2 align-items-center d-flex">
							<img src="asset/image/menu_createnote_icon.png" height="15" on-error="asset/image/default_favicon.png" class="backToWhite">
						</div>   
						<div class="py-2">
							<p class=" entryTitle m-0 py-1 text-truncate">${eitem.title || 'Untitled'}</p>
						</div>
					</div></a>
				</li> 
			`);
		} else {
			if (eitem.title.length > 0) {
				tsBlock = $(`<li class="pointer dropdown-item apps_typeahead plastic_typeahead ui-menu-item-wrapper">
						<a class="fullLi url-click" target="${urlTarget}" role="menuitem" tabindex="1">
						<div class="d-flex align-content-center">	     
							<div class="iconsleft pr-2 align-items-center d-flex">
								<img src="${eitem.favIconUrl}" height="15" on-error="asset/image/default_favicon.png">
							</div>   
							<div class="py-2">
								<p class=" entryTitle m-0 py-1 text-truncate">${eitem.title} - <span class="gray">Google Search</span></p>
							</div>
						</div></a>
					</li> 
				`);
			} else {
				return "";
			}
		}
	}

	return tsBlock;
}
   

function profilePop() {
	$('#profile_container').append(`
		<div class="themesettings row clearfix" style="display: none;">
	        <div class="col-sm-12">
	          <div class="media" id="before_login">
	            <div class="media-body pl-3">
	              <h4 class="mb-2">Account</h4>
	              <div class="row mb-3">
	                <div class="col-sm-3">
	                  <button class="btn theme_btn btn-block open-login">
	                    Login
	                  </button>
	                </div>
	                <div class="col-sm-1 text-center">OR</div>
	                <div class="col-sm-3">
	                  <button class="btn theme_btn btn-block open-signup">
	                    Signup
	                  </button>  
	                </div>
	              </div>
	            </div> 
	          </div>
	          <div class="media hide" id="after_login">
	            <div class="media-body">
	              <h4 class="mb-2">Account</h4>
	              <h6 id="acc_username">Name (email@gmail.com)</h6>
	              <h6>
	              	<small id="edit-profile" class="link-hover">
	              		Edit Account
	              	</small>
	              </h6>
	            </div>
	            <div class="media-right">
	                <img src="asset/image/logout.png" class="invert_color pointer logout-btn" height="20" id="logout_btn">
	            </div>
	          </div>
	          <hr class="mt-0">
	        </div>
	        <div class="col-sm-6 pb-4">
	          <h6>Theme</h6>
	          <div class="d-flex">
	          	<div class="toggle-wrapper">
					<input name="changeTheme" type="checkbox" id="changeTheme" autocomplete="changeTheme" />
					<label for="changeTheme" class="toggle">
						<span class="toggle__ray">
							<span class="ray ray--1"></span>
							<span class="ray ray--2"></span>
							<span class="ray ray--3"></span>
						</span>
						<span class="toggle__items">
							<span class="glare"></span>
							<span class="dot dot--1"></span>
							<span class="dot dot--2"></span>
							<span class="dot dot--3"></span>
						</span>
					</label>
				</div>
	            &nbsp;<small class="flex-grow-1 line-height20 colorGry" id="change_theme_txt"> Change to dark theme</small>
	          </div>
	        </div>
	        <div class="col-sm-6 pb-4">
	          <h6>Tabs</h6>
	          <div class="d-flex">
	          	<div class="new_tab">
	              <input name="close_tab" id="tab_status_on_save" type="checkbox" autocomplete="tab_status_on_save">
	              <div class="dots"></div>
	            </div>
	            <small class="flex-grow-1 line-height20 colorGry"> &nbsp; Close tabs on save</small>
	          </div>
	        </div>

	        <div class="col-sm-6 pb-4">
	          <h6>Links</h6>
	          <div class="d-flex">
	          	<div class="new_tab">
	              <input name="close_tab" id="open_links_in_new_tabs" type="checkbox" autocomplete="close_tab">
	              <div class="dots"></div>
	            </div>
	            <small class="flex-grow-1 line-height20 colorGry"> &nbsp; Open links in new tab</small>
	          </div>
	        </div>
	        <div class="col-sm-12 d-none"><hr class="mt-0"></div>
	        <div class="col-sm-6 pb-4 d-none">
	          <div class="d-flex">
	          	<a target="_blank" href="https://help.qlearly.com/v2/how-to-turn-off-the-new-tab-feature">
	            	<small class="flex-grow-1 line-height20"> Turn off new tab </small>
	           	</a>
	          </div>
	        </div>

	        <div class="col-sm-12"><hr class="mt-0"></div>
	        <div class="col-sm-4 d-none">
	          <div class="d-flex">	            
	              <button class="btn theme_btn btn-block" id="upgrade_btn">
	                Upgrade
	              </button>            
	          </div>
	        </div>
	        <div class="col-sm-12 d-none"><hr class="mt-0"></div>
	        <div class="col-sm-6">
	          	<h6>About Qlearly</h6>
	           	<h6 class="flex-grow-1 paragraph colorGry">
	           		<p class="link-hover" data-toggle="modal" data-target="#short_cut_modal">Keyboard Shortcuts (Shift + A)</p>
	           		<p><a href="https://qlearly.com/contact" class="colorGry link-hover" target="_blank"><p>Contact&nbsp;&&nbsp;Feedback</p></a></p>
	           		<p><a href="https://help.qlearly.com/v2/how-to-turn-off-the-new-tab-feature" class="colorGry link-hover" target="_blank">Turn off new tab</a></p>
	           		<p class="mb-0"><a href="https://help.qlearly.com/v2" class="colorGry link-hover" target="_blank">Help Center</a></p>
	           	</h6>
	        </div>
	         <div class="col-sm-6">
	          <h6>Get in touch</h6>
	          <a href="https://twitter.com/QlearlyHQ" target="_blank"><p class="link-hover flex-grow-1 paragraph colorGry">Find us on Twitter</p></a>
	          <a href="https://www.instagram.com/Qlearly" target="_blank"><p class="flex-grow-1 paragraph link-hover colorGry">Find us on Instagram</p></a>
	          <a href="https://www.facebook.com/qlearly/" target="_blank"><p class="flex-grow-1 paragraph colorGry link-hover mb-0">Find us on Facebook</p></a>
	          <p class="flex-grow-1 paragraph colorGry hide">Share Qlearly On Twitter - <span class="twitter-icon"></span> <span class="fb-icon"></span></p>
	        </div>
	      </div>
	`);

	$(document).on('click', '.logout-btn', function(evt) {
		auth.logout();
		setTimeout(function(){ document.location.reload(); }, 500);
	});

	$('#change_theme_txt').html('  Change to dark theme');
	if (localStorage.getItem("changeThemeColor") == 'true') {
		$('#change_theme_txt').html('  Change to light theme');
	}

	if (localStorage.getItem("tab_status_on_save") == 'true') {
		$('#tab_status_on_save').prop('checked', true);
	}

	if (localStorage.getItem("open_links_in_new_tabs") == 'true') {
		$('#open_links_in_new_tabs').prop('checked', true);
	}

	$('#open_links_in_new_tabs').click(function() {

		if (localStorage.getItem("open_links_in_new_tabs") == 'false') {
			localStorage.setItem("open_links_in_new_tabs", "true");
		} else {
			localStorage.setItem("open_links_in_new_tabs", "false");
		}
	});

	$("#tab_status_on_save").change(function (event) {
		if(!auth.isLoggedIn()){
			$("#tab_status_on_save").prop('checked', false);
			$('.open-signup').trigger('click');
			return false;
		}

		if (localStorage.getItem("tab_status_on_save") == 'false') {
			localStorage.setItem("tab_status_on_save", "true");
		} else {
			localStorage.setItem("tab_status_on_save", "false");
		}
	});

	if (auth.isLoggedIn()) {
		$('#after_login').css({
			"display": "flex"
		});
		$('#before_login').hide();
		$('#acc_username').html(auth.user().name.ucfirst() + ' (' + auth.user().email + ')');
	}


	$('#upgrade_btn').click( function() {
		if(!auth.isLoggedIn()) {
			$('.open-login').trigger('click');
			return false;
		}
		document.location.href = WEB_URL + '/beta/pricing2/' + auth.user().id;
	});


	$('#edit-profile').click(function(){
		document.location.href = chrome.extension.getURL('/index.html?page=profile');
	})

}

if ($('#profile_container').length > 0) {
	
	profilePop();
	
}


function addUserToSharableList(users) {

	$('#sharable_user_list').html('');
	$('#spop_selected_user_count').html(`Person(${users.length + 1})`);
	let status = '(Invitation pending)';
	let removeButton = '';
	users.forEach(function (item) {

		status = item.email;
		removeButton = `<div class="media-right pl-2 text-primary">						
			<img src="asset/image/cross_icon.png" height="14" class="link-hover cancel-invitation" data-id="${item.id}">
		</div>`;

		$('#sharable_user_list').append(`
			<li class="list-group-item py-2" id="invitation-container-${item.id}">
		         <div class="media">
					<div class="media-left pr-2 text-primary">
						<img src="asset/image/tick.svg" height="14">
					</div>
		            <div class="media-body">${item.name || item.email}</div>
		            <div class="media-right">
		              <small class="colorGry">${status}</small>
					</div>
					${(authController.data.id !== item.id)? removeButton : ''}
		         </div>
		      </li>
		`);
	});
}

function getSyncableData(callback) {

	callback({
		folders: JSON.stringify(folder.get().filter(item => { return item.sync == "true" || item.sync == true; } )),
		boards: JSON.stringify(board.get().filter(item => { return item.sync == "true"; } ).map( item => { item.column = []; return item; })),
		columns: JSON.stringify(board.columns().filter(item => { return item.sync == "true"; } )),
		entries: JSON.stringify(entry.get().filter(item => { return String(item.sync) == "true" } )),
		remove_entries: JSON.stringify(entry.getRemovedItem().map(a => a.id)),
		remove_board: JSON.stringify(board.getRemovedItem().map(a => a.id)),
		remove_column: JSON.stringify(board.getRemovedColumn().map(a => a.id)),
		sync_board: localStorage.getItem("sync_board"),
		subscription: String((auth.user().subscription !== null))
	});
}

function sync2(callback, local_update, options) {

	options = options || {};
	if (auth.isLoggedIn()) {

		if(!options.hasOwnProperty('url')){
			options.url = service.version + "sync";
		}
		getSyncableData(function(param) {

			if(ajaxLastRequest) {
				ajaxLastRequest.abort();
			}

			if($('.board-detail-page').length > 0) {
				param.board_id = currentBoard.id;
			}
			if(options.hasOwnProperty('get_data')) {
				param.get_data = options.get_data;
			}

			service.post2(options.url, param, function (response) {

				if (response.success == true) {

					localStorage.setItem('last_sync', Date.now());
					board.saveRemoved([]);
					entry.saveRemoved([]);
					if(local_update == true) {
						if(response.hasOwnProperty('folders')) {
							folder.save(response.folders);
						}

						if(response.hasOwnProperty('data')) {
							board.save2(response.data);
							// if(board.get().length < 1) {
							// 	board.save2(response.data);
							// }
						}

						if(response.hasOwnProperty('board')) {

							response.board.forEach( item => {
								boardController.update(item.id, item, {
									sync: false
								});
							});
							
						}

						if(response.hasOwnProperty('entry')) {
							
							var newEntries = EntryCtrl.get().filter((item) => {
								return item.board_id !== currentBoard.id;
							});
							
							newEntries.map(item => {
								item.sync = 'false';
								delete item.sync;
								return item;
							});

							EntryCtrl.save(newEntries.concat(response.entry));							
						}
						
						if(response.hasOwnProperty('users')) {
							users.save(response.users);
						}
						
						if(response.hasOwnProperty('self')) {
						
							if(response.self.sync_board) {
								localStorage.setItem("sync_board", String(response.self.sync_board));						
							}
						}
					}
				}

				if(typeof callback === 'function') {
					callback();
				}
			});
		});
	}
}

$('#sync_board_btn').click(function() {
	
	if (auth.isLoggedIn()) {
		$('.big-centered-loader').show();
		sync2(function() {
			$('.big-centered-loader').hide();
			if($('.board-detail-page').length > 0) {
				currentBoard.init();
			}
		 }, true, {
			 url: service.version + "sync_new"
		 });
	} else {
		$('.open-signup').trigger('click');
	}

});

sync2(function() {  }, true, {
	get_data: true
});


$(document).on('click', '[data-tab-highlight]', function(){
	chrome.tabs.update(parseInt($(this).attr('data-tab-highlight')), {highlighted: true});
});

$(document).on('click', '[data-close-tab]', function(){
	chrome.tabs.remove(parseInt($(this).attr('data-close-tab')));
});


function rightSessionComponent(tab) {

	if (!tab.url || tab.url == 'chrome://newtab/' || tab.url.search(new RegExp(currentExtUrl, 'i')) > -1) {
		return false;
	}

	if ($('#csc_right').find(`[data-tabid="${tab.id}"]`).length > 0) {
		return false;
	}

	currentSession[tab.id] = tab;
	$('#csc_right').find('.csc-entry-list').append(
		`<li class="list-group-item pointer entry-block ${tab.type}" data-tabid="${tab.id}" >
            <div>
              <a class="fullLi link-hover current-tab" data-tab-highlight="${tab.id}"></a>
              <a class="fullLi link-hover bookmark-url" href="${tab.url}" target="_blank"></a>
              <div class="d-flex align-content-center">      
                <div class="iconsleft pr-2 align-items-center d-flex">
                    <img src="${tab.favIconUrl}" height="15" on-error="asset/image/default_favicon.png">
                </div>   
                <div class="py-2">
                  <p class=" entryTitle m-0 py-1 text-truncate">${tab.title}</p>
               </div>			   
			   <div class="dropdown action controls dropleft position-relative" style="z-index:2;" data-close-tab="${tab.id}">
					<a class="pointer" role="button">
						<div class="cardaction"><img class="w-50" src="asset/image/delete.png" /></div>
					</a>
				</div>

            </div>
          </div>
        </li> `
	);
}


function renderBookmark() {
	
	controller.getAllBookmarks(function(bookmarks) {
		bookmarks.allBookmarks.forEach(bookmark => {

			rightSessionComponent({
				id: bookmark.id,
				title: bookmark.title,
				url: bookmark.url,
				type:'bookmark',
				favIconUrl: 'https://www.google.com/s2/favicons?domain=' + bookmark.url
			});
		});
	}); 
}



function updateCurrentSession() {	
	$('#csc_right').find('.csc-entry-list').html('');

	if(rightSideBar == 'bookmark') {
		renderBookmark();
		return;
	}
	chrome.tabs.query({
		currentWindow: true,
		active: false
	}, function (tabs) {

		if (tabs.length < 1) {
			$('#csc_right').find('.csc-entry-list').html('<li class="text-center">You have no open tabs</li>');
		}
		tabs.forEach(function (tab) {

			tab.type = 'tabs';
			rightSessionComponent(tab);

		});
	});
}

chrome.tabs.onRemoved.addListener(function (updatedTab) {
	updateCurrentSession();
	make_csc_entry_sortable();
});
chrome.tabs.onCreated.addListener(function (updatedTab) {
	updateCurrentSession();
	make_csc_entry_sortable();
});


function make_csc_entry_sortable() {

	if ($('.csc-entry-list').length > 0) {
		if($('#column_container').length > 0) {
			$('.csc-entry-list').sortable({
				connectWith: '.entry-list',
				placeholder: "ui-state-highlight list-group-item",
				helper: "clone",
				appendTo: '#column_container',
				start: function (event, ui) {
					ui.item.addClass('tilt');
					ui.item.addClass('entry-sidebar-session');
					tilt_direction(ui.item);
				},
				stop: function (event, ui) {

					ui.item.removeClass("tilt");
				},

			});
		}
	}
}


function open_sharable_modal(id) {

	if (!auth.isLoggedIn()) {
		$('.open-signup').trigger('click');
		return false;
	}
	newInvitedUser = [];
	selColumnUsers = [];
	selectedColumn = null;
	sharableBoard = board.first(id);
	selColumnUsers = users.get().filter(function (item) {
		return (item.board_ids.indexOf(id) > -1);
	});

	$('#search_from_sharable_popup').val('');
	$('#spop_users_list').show();
	$('#spop_no_users_filtered').hide();
	$('#spop_share_user_btn_block').hide();

	defualtSharableLink();

	// if (selColumnUsers.getIndex('email', auth.user().email) < 0) {
	// 	selColumnUsers.unshift({
	// 		'id': auth.user().id,
	// 		'name': auth.user().name,
	// 		'email': auth.user().email,
	// 		'status': 'accepted'
	// 	});
	// }

	addUserToSharableList(selColumnUsers);

	$('#share_column').modal('show');
	if (!selectedColumn) {
		$('#selected_collection').html('Share Board "' + sharableBoard.name + '"');
		$('#show_all_teammates').html('Show all teammates in "' + sharableBoard.name + '"');
		if (sharableBoard.sharable_code) {
			changeSharableLink(sharableBoard.sharable_code, 'b');
		}
		$('#seo_author').val(sharableBoard.author);
		$('#seo_title').val(sharableBoard.meta_title);
		$('#seo_made_by_url').val(sharableBoard.author_url);
		$('#seo_description').val(sharableBoard.meta_description);
		$('#sharable_code').val(sharableBoard.sharable_code);
		$('#seo_image_preview').attr('src', sharableBoard.image);

		$('#seo_image_container').removeClass('blank');
		if(!sharableBoard.image) {
			$('#seo_image_container').addClass('blank');
		}
	}
}

function createContextMenu() {
	  chrome.extension.getBackgroundPage().createContextMenu();
}


if($('#import_urls').length > 0) {

var rowData = [];
$('#import_urls').click(function(evt){
	
	let import_editor = $('#import_editor').val()

	if(!import_editor.trim()) {
		alert('Enter at least 1 record');
		return;
	}
	import_editor = import_editor.split("\n");
	var lastIndex = entry.lastSortable(currentBoard.activeColumn);

	import_editor.forEach(function(row, index){
		if(row.trim()) {
			rowData = row.split('|');
			currentBoard.createEntry({
				title: rowData[1] || rowData[0],
				url: rowData[0],
				favIconUrl: 'https://www.google.com/s2/favicons?domain='+ rowData[0],
				sortable: ++lastIndex
			});
		}
	});

	setTimeout(function(){ sync2('', false); }, 1000);

	$('#import_export_model').modal('hide');
	$('#import_editor').val('')
});

$('#edit_all_urls').click( function(evt) {
	$(this).hide();
	$('#save_all_urls').show();
	$('#export-editor-title').html('Edit URLs');
	exportData({ withid: true });
});

$('#save_all_urls').click( function(evt) {
	$(this).hide();
	$('#edit_all_urls').show();
	$('#export-editor-title').html('Export URLs');

	let editable_links = $('#export_editor').val()

	if(!editable_links.trim()) {
		exportData();
		return;
	}

	editable_links = editable_links.split("\n");

	editable_links.forEach(function(row, index){
		if(row.trim()) {
			rowData = row.split('|');

			console.log(rowData);
			console.log(rowData[0].trim());
			if(rowData[2]) {
				entry.updateLocal(rowData[2].trim(), {
					title: (rowData[1] || rowData[0]).trim(),
					url: rowData[0].trim(),
					favIconUrl: 'https://www.google.com/s2/favicons?domain='+ rowData[0]
				});
			}
		}
	});
	exportData();
});



$('#import_export_model').on('shown.bs.modal', function () { exportData(); });
$('#import_export_model').on('hidden.bs.modal', function () { $('#export_editor').val(''); });

function exportData(param={}) {

	let export_editor = [];
	$('#export_editor').val('');
	entry.getByColumn(currentBoard.activeColumn).forEach(function(item){
		if(item.type !== 'link') return;
		if(param.hasOwnProperty('withid')){
			export_editor.push(item.url + ' | '+ item.title + ' | '+ item.id);
		} else {
			export_editor.push(item.url + ' | '+ item.title);
		}
		$('#export_editor').val(export_editor.join('\n'));
	});
}

}

function loadIntroduction() {

	setTimeout(function(){

		var intro = introJs();
	  	intro.setOptions({
	  	exitOnEsc:false,	
	  	showStepNumbers:false,
	  	exitOnOverlayClick:false,
	    steps: [
	    	{
	    		element: document.querySelectorAll('.column-block')[0],
		        intro: "Here is a list of your current bookmarks. Drag and drop them around to start customizing your board."
	    	},
	    	{
	    		element: document.querySelectorAll('.save-tabs-on-board-btn')[0],
		        intro: "You can use this button to save all the tabs you currently have opened in one click."
	    	},
	    	{
	    		element: '#setting-dropdown',
		        intro: "Use this button to Delete, Duplicate or Share a board."
	    	},
	    	{
	    		element: '#center_search',
		        intro: "Search through your cards or search Google right from Qlearly."
	    	},
	    	{
	    		element: '#showCrntSsion_container',
		        intro: "This feature allows you to drag and drop a single tab into a board."
	    	},
	      	{
	      		element: '.pop-walkthrought-container',
		        intro: "Select a column and click 'Save All' to save all tabs, or 'Save Current' to save the tab you are currently on. "
		    },
	      	{
	      		element: '.contextmenu-wlkth-container',
		        intro: "You can also use your right click from any website to save it to a specific column."
		    },
	    ]
	  });

	  	intro.onbeforechange(function(targetElementId) {  
		    $('.pop-walkthrought-container').hide();
		    $('.contextmenu-wlkth-container').hide();
		    switch($(targetElementId).attr("data-step")) {
		        case "1":
		        	$(targetElementId).show();
		        break;
		        case "2":
		        	$(targetElementId).show();
		        break;
		    }
		})
		.onbeforeexit(function() {
			$('.contextmenu-wlkth-container').hide();
			$('.pop-walkthrought-container').hide();
			localStorage.setItem('introstatus', 'completed');

			    
			new Confetti({
				width    : window.innerWidth,
				height   : window.innerHeight,
				length   : 220,
				duration : 8000
			});
			
			setTimeout(() => {
			    $('canvas').remove();
			}, 8000);  

		});
	  intro.start();
	}, 500);
}


$(document).ready(function () {
	if (localStorage.getItem("qleary_is_default_created")) {
		if(localStorage.getItem('introstatus') != 'completed' && $('.board-detail-page').length > 0) {

			var s = document.createElement('script');
		    s.src = chrome.extension.getURL('asset/js/intro.min.js');
		    s.onload = loadIntroduction;
		    document.body.appendChild(s);

		    s = document.createElement('script');
		    s.src = chrome.extension.getURL('asset/js/conffeti.min.js');
		    document.body.appendChild(s);


			$('body').append(`<div class="pop-walkthrought-container hide" data-step="1"><img src="asset/image/walkthrough/popup.png"> </div>
				<div class="contextmenu-wlkth-container hide" data-step="2"><img src="asset/image/walkthrough/contextmenu.png"> </div>`);
			
		}
	}

	if($('#edit_note_form').length > 0) {
		$('#edit_note_form').submit( function( evt ) {
			evt.preventDefault();
			if(entryDetail) {
				entry.update(entryDetail.id, {
					"title": $('#note_title').val(),
					"description": $('#note_body').val()
				});
				entryObject($('#note_title').val(), $('#note_body').val());
				$('#edit_note_model').modal('hide');
				sync2('', true);
			}
		});
	}	
});


function defaultSocialColumn(columnId, boardId) {

	defaultLinksForColumn.social.forEach((item, index) => {
		entry.create({
	  		board_id: boardId,
			column_id: columnId,
			title: item.title,
			url: item.url,
			sortable: index,
			favIconUrl: item.favIconUrl
		});
	});
}

function defaultWorkColumn(columnId, boardId) {
	
	defaultLinksForColumn.work.forEach((item, index) => {
		entry.create({
	  		board_id: boardId,
			column_id: columnId,
			title: item.title,
			url: item.url,
			sortable: index,
			favIconUrl: item.favIconUrl
		});
	});
}

function defaultChecklistColumn(columnId, boardId) {

	defaultLinksForColumn.checklist.forEach((item, index) => {
		entry.create({
	  		board_id: boardId,
			column_id: columnId,
			title: item.title,
			type: "checklist",
			sortable: index
		});
	});
}

function saveBookMarks(columnId, boardId) {
	
	controller.getAllBookmarks(function(bookmarks) {
		bookmarks.allBookmarks.forEach((bookmark, index) => {
			entry.create({
		  		board_id: boardId,
				column_id: columnId,
				title: bookmark.title,
				url: bookmark.url,
				sortable: index,
				favIconUrl: 'https://www.google.com/s2/favicons?domain=' + bookmark.url
			});
		});

		if($('.board-detail-page').length > 0) {
			currentBoard.init();
		}
	});
}


$(document).on('mouseenter', '.js-hover-to-show-sibling', function(event) {
    event.preventDefault();

    var $content = $(this).siblings('.js-content-to-show');
    $content.addClass('state-visible');
});

$(document).on('mouseleave', '.js-hover-to-show-sibling', function(event) {
    event.preventDefault();

    var $content = $(this).siblings('.js-content-to-show');
    $content.removeClass('state-visible');
});


var BoardCtrl = {
	delete: () => {
		// Delete board
		if($('#delete_board').length > 0) {
			$('#delete_board').click(function() {
				if(confirm('Are you sure, you want to remove this board?')) {
					boardController.delete(currentBoard.id);
					var firstBoard = boardController.get();
					if(firstBoard.length < 1) {
						document.location.reload();
						return;
					}
					currentBoard.id = firstBoard[0].id;
					currentBoard.init();
				}
			});
		}
	},
	copy: () => {
		//copy board event

		if($('#duplicate_board').length > 0) {
			$('#duplicate_board').click(function() {
				BoardCtrl.copyBoard(currentBoard.id);
				board.renderMenu();				 
			});
		}
	},
	copyBoard: (boardId) => {
		var boardDetail = boardController.first(boardId);

		var folderDetail = folder.first(boardDetail.folder_id);

		if(!folderDetail.hasOwnProperty('id')) {
			folderDetail = folder.create({ title: 'Duplicated Boards' });
		}
		if(!folderDetail.hasOwnProperty('id')) {
			alert('Something went wrong');
			return;	
		}
		var entries = [];

		var newColumns = boardDetail.column.map( item => {

			var newcolumn = boardController.columnObject(item.name); 

			// create entry collection
			EntryCtrl.getByColumn(item.id).forEach( entryObj => {
				entries.push({
					column_id: newcolumn.id,
					title: entryObj.title,
					url: entryObj.url || '',
					type: entryObj.type,
					sortable: entryObj.sortable,
					favIconUrl: entryObj.favIconUrl
				});
			});

			return newcolumn;
		});

		var latestBoard = boardController.create({
			folder_id: folderDetail.id,
			name: boardDetail.name + ' Copy',
			column: newColumns
		})

		EntryCtrl.createBatch(entries.map( item => {
			item.board_id = latestBoard.id;
			return item;
		}));
	},
	export: () => {
		$('#export_board_btn').click(function() {
			BoardCtrl.exportData(currentBoard.id);
		});
	},
	exportData: (boardId) => {

		var htmlString = [];
		var boardDetail = boardController.first(boardId);
		boardDetail.column.map(function(column) {

			htmlString.push(
				'<DL>' + 
				`<H3 ADD_DATE="1520240353" LAST_MODIFIED="1564125135">${column.name}</H3>`+
				EntryCtrl.getByColumn(column.id).map( item => {
					// if(item.hasOwnProperty('description') && item.description !== undefined){
					// 	return `<DT><A DESCRIPTION="${item.description}" STATUS="${item.status}" SORTABLE="${item.sortable}" TYPE="${item.type}" HREF="${item.url}" ICON_URI="${item.favIconUrl}" ICON="data:image/png;base64,iV">${item.title}</A><div>${item.description}</div></DT>`;
					// }
					return `<DT><A DESCRIPTION="${item.description}" STATUS="${item.status}" SORTABLE="${item.sortable}" TYPE="${item.type}" HREF="${item.url}" ICON_URI="${item.favIconUrl}" ICON="data:image/png;base64,iV">${item.title}</A></DT>`;
				}).join('') + 
				'</DL>' 
			);
			return column;
		});
	
		var fileName = boardDetail.name + ' ' + (new Date()).toString();
		//var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(boardDetail));
		var dataStr = "data:text/html;charset=utf-8," + encodeURIComponent(`<H1>${boardDetail.name}</H1><dl><dt>${htmlString.join('')}</dt> </dl>`);
		var dlAnchorElem = document.getElementById('downloadAnchorElem');
		dlAnchorElem.setAttribute("href",     dataStr     );
		dlAnchorElem.setAttribute("download", fileName + ".html");
		dlAnchorElem.click();
	},
	import: () => {

		$('#import_bookmark_file').change( function( evt ) {
			
			var f = evt.target.files[0];
			if (f) {
				var r = new FileReader();
				r.onload = function (e) {
					var contents = e.target.result;
					
					var data = [];

					$(contents).find('DL').each( function() {
						if($(this).find('h3').length > 0) {
							
							var columnObj = board.createNewColumn(currentBoard.id, {
								name: $(this).find('h3').text()
							});

							if($(this).find('dt').length > 0) {
								
								var index = 1;
								$(this).find('dt').each( function() {
									
									var a = $(this).find('a');
									
									data.push({
										board_id: currentBoard.id,
										column_id: columnObj.obj.id,
										title: a.text(),
										url: a.attr('href'),
										sortable: index + 1,
										type: a.attr('type') || '',
										description: a.attr('description') || '',
										status: a.attr('status'),										
										favIconUrl: a.attr('icon_uri')
									});
								});	
							}
						}
					});

					setTimeout(() => {
						EntryCtrl.createBatch(data);
						currentBoard.init();
						$('#import_bookmark_modal').modal('hide');
						// sync2();
					}, 100);
					
				}
				r.readAsText(f);
			} else {
				alert("Failed to load file");
			}
			
		});
	},
	helpCrunchCode: () => {
		(function(w,d){
			w.HelpCrunch=function(){w.HelpCrunch.q.push(arguments)};w.HelpCrunch.q=[];
			function r(){var s=document.createElement('script');s.async=1;s.type='text/javascript';s.src='https://widget.helpcrunch.com/';(d.body||d.head).appendChild(s)};
			if(w.attachEvent){w.attachEvent('onload',r)}else{w.addEventListener('load',r,false)}
		})(window, document)
	
		HelpCrunch('init', 'qlearly', {
			applicationId: 1,
			applicationSecret: '8t/IF280pEC67nfSs2MTVsfSZbx2R2hU9Ukq9nqO3YrvJcaeHgopQpsM2w7/sF1qxj4vFqK/oGFJIGAJ5izojA=='
		});
	
		HelpCrunch('showChatWidget');
	}
}

if($('.board-detail-page').length > 0) {
	BoardCtrl.delete();
	BoardCtrl.copy();
	BoardCtrl.export();
	BoardCtrl.import();
}

if ($('.board-page').length > 0) {
	BoardCtrl.helpCrunchCode();	
}

if($('#selected_board_name')) {
	$('#selected_board_name').focus(function(){
		$(this).parent().addClass('active');
	})
	.focusout(function(){
		$(this).parent().removeClass('active');
	})
}

var _AnalyticsCode = 'UA-128048903-1';

var _gaq = _gaq || [];
_gaq.push(['_setAccount', _AnalyticsCode]);
_gaq.push(['_trackPageview']);
_gaq.push(['_trackEvent', 'open_bookmark_btn', 'clicked', 'Open Bookmark List']);

(function () {
	var ga = document.createElement('script');
	ga.type = 'text/javascript';
	ga.async = true;
	ga.src = 'https://ssl.google-analytics.com/ga.js';
	var s = document.getElementsByTagName('script')[0];
	s.parentNode.insertBefore(ga, s);
})();


if ($('.note-page, .board-page, .board-detail-page').length > 0) {

	if(authController.showAds()) {
		  (function() {
			var w = window;
			var d = document;
			function l() {
			  var s = d.createElement("script");
			  s.type = "text/javascript";
			  s.async = true;
			  s.src = "https://app.usemagnify.com/widget/697170c6-e69f-4e95-927f-146e76d753e2";
			  var x = d.getElementsByTagName("script")[0];
			  x.parentNode.insertBefore(s, x);
			}
			if (w.attachEvent) {
			  w.attachEvent("onload", l);
			} else {
			  w.addEventListener("load", l, false);
			}
		  })();
	}
	
	// confirm box html

	$('body').append(`
	<div class="modal fade" id="confirm_box">
		<div class="modal-dialog">
			<div class="modal-content">				
				<div class="modal-body text-center pb-4">
					<button type="button" class="close" data-dismiss="modal">Ã—</button>
					<img src="/asset/image/popup-delete.png" height="90">
					<h3 class="my-3">Please Confirm</h3>
					<i id="modal_body">Are you sure, you want to remove this folder?</i>
				</div>
				<div class="modal-footer d-flex px-sm-5 px-3 py-4 ">
					<div class="col">
						<button type="button" class="btn btn-danger btn-lg btn-block" data-dismiss="modal" id="confirmed_to_action">Confirm</button>
					</div>
					<div class="col">
						<button type="button" class="btn btn-lg btn-block" data-dismiss="modal">Cancel</button>
					</div>
				</div>
			</div>
		</div>
	</div>`
	);

	// confirm box function

	window.confirmBox = {
		title: 'Please Confirm',
		body: 'Are you sure, you want to remove this record?',
		callback: function() {},
		init: function(body) {
			window.confirmBox.title = 'Please Confirm';
			window.confirmBox.body = body || 'Are you sure, you want to remove this record?';
			$('#confirm_box').modal('show');
		}
	};
	$('#confirm_box').on('shown.bs.modal', function() {
		$('#modal_heading').html(window.confirmBox.title);
		$('#modal_body').html(window.confirmBox.body);
	});

	$('#confirmed_to_action').click(function() {
		confirmBox.callback();
	});


	// end confirm box
}

